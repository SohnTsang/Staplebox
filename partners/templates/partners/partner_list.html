{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% load crispy_forms_filters %}

{% block title %}Partner List{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/bootstrap-icons.css' %}">
<style>
	.sidebar {
		min-width: 250px;
		max-width: 250px;
	}
	.bg-primary-custom {
		background-color: var(--bs-primary);
	}
	.text-primary-custom {
		color: var(--bs-primary) !important;
	}
	.wrapper {
		width: 100%;
		box-shadow: 2px 4px 20px rgba(0,0,0,.08);
	}
	.list-group-item {
		border-left: none !important;
		border-right: none !important;
		border-top: 1px solid #dee2e6 !important; /* Bootstrap's default border color */
		border-bottom: 1px solid #dee2e6 !important;
		width: 100%; /* Ensure full width */
		margin-left: 0; /* Align with parent's left edge */
		margin-right: 0; /* Align with parent's right edge */
	}

	/* Remove top border for the first item */
	.list-group-item:first-child {
		border-top: none !important;
	}

	/* Optionally, if you want no border on the last item, use this */
	.list-group-item:last-child {
		border-bottom: none !important;
	}

	.invitation-list {
		max-height: 700px; /* or your preferred height */
		overflow-y: scroll; /* Always shows vertical scrollbar */
	}

</style>
{% endblock extra_css %}

{% block content %}
<div class="container mt-5">
	<div class="row">
		<!-- Main Content -->
		<div class="col-md-8">
            <div class="bg-white rounded-3 wrapper border">
                <h3 class="text-primary-custom mb-3 fw-bold px-5 py-3 border-bottom">My Partners</h3>
                <button type="button" class="btn btn-primary mb-3 ms-5" data-bs-toggle="modal" data-bs-target="#sendInvitationModal">
                    Send Invitation
                </button>
                <div class="list-group">
                    {% for partnership in partnerships %}
                    <div class="list-group-item flex-column align-items-start px-5">
                        <div class="d-flex justify-content-between align-items-center py-1">
                            <div class="">
								{% if request.user.username == partnership.exporter.username %}
									<h5 class="mb-1">{{ partnership.importer.username }}</h5>
								{% else %}
									<h5 class="mb-1">{{ partnership.exporter.username }}</h5>
								{% endif %}
                                <small>Partnership since: {{ partnership.created_at|date:"M d, Y" }}</small>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                    Actions
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                    <li><a id="delete-partner" class="dropdown-item" href="#" data-partner-id="{{ partnership.id }}">Delete</a></li>
                                    <!-- Add more actions here -->
                                </ul>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <p>No partners yet.</p>
                    {% endfor %}
                </div>
            </div>
        </div>

		<!-- Right Sidebar for Invitations -->
		<div class="col-md-4 invitation-list">
            <div class="bg-white rounded-3 wrapper border">
				<h4 class="text-primary-custom fw-bold px-5 py-3 border-bottom">Partner Invitation</h4>
				<ul class="nav nav-tabs px-4" id="invitationTab" role="tablist">
					<li class="nav-item" role="presentation">
						<button class="nav-link active" id="received-tab" data-bs-toggle="tab" data-bs-target="#received" type="button" role="tab" aria-controls="received" aria-selected="true">Received</button>
					</li>
					<li class="nav-item" role="presentation">
						<button class="nav-link" id="sent-tab" data-bs-toggle="tab" data-bs-target="#sent" type="button" role="tab" aria-controls="sent" aria-selected="false">Sent</button>
					</li>
				</ul>
				<div class="tab-content" id="invitationTabContent">
					<div class="tab-pane fade show active" id="received" role="tabpanel" aria-labelledby="received-tab">
						<div class="list-group">
							{% for invitation in received_invitations %}
							<div class="list-group-item list-group-item-action px-5 py-3">
					
								From: {{ invitation.sender.email }}
								<br>
								Status: {{ invitation.accepted|yesno:"Accepted,Pending" }} <br>
								Received: {{ invitation.created_at|date:"g:i, Y-M-d" }} <!-- Displaying received timing -->
					
								<!-- Check if the invitation is not yet accepted and display the Accept link -->
								{% if not invitation.accepted %}
								<br>
								<a href="{% url 'invitations:accept_invitation' token=invitation.token %}" class="btn btn-success">Accept Invitation</a>
								{% endif %}
							</div>
							{% empty %}
							<p>No invitations received.</p>
							{% endfor %}
						</div>
					</div>
					<div class="tab-pane fade" id="sent" role="tabpanel" aria-labelledby="sent-tab">
						<div class="list-group">
							{% for invitation in sent_invitations %}
							<div class="list-group-item list-group-item-action px-5 py-3" id="invitation-{{ invitation.id }}">
								To: {{ invitation.email }}
								<br>
				
								Status: {{ invitation.accepted|yesno:"Accepted,Pending" }} <br>
								Received: {{ invitation.created_at|date:"g:i, Y-M-d" }}<!-- Displaying received timing -->
				
								{% if not invitation.accepted %}
								<br>
								<button id="delete-invitation" class="btn btn-danger btn-sm" data-invitation-id="{{ invitation.id }}">Delete</button>
								{% endif %}
				
							</div>
							{% empty %}
							<p>No invitations sent.</p>
							{% endfor %}
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

{% include "modal/send_invitation_modal.html" %}

{% block javascript %}

<script>
	document.addEventListener('DOMContentLoaded', function() {
		// Event listener for deleting partners
		document.querySelectorAll('#delete-partner').forEach(button => {
			button.addEventListener('click', function() {
				const partnerId = this.getAttribute('data-partner-id');
				if(partnerId) {
					deleteEntity('partner', partnerId);
				}
			});
		});
	
		// Event listener for deleting invitations
		document.querySelectorAll('#delete-invitation').forEach(button => { // Assuming a class for invitation delete buttons
			button.addEventListener('click', function() {
				const invitationId = this.getAttribute('data-invitation-id');
				if(invitationId) {
					deleteEntity('invitation', invitationId);
				}
			});
		});
	});
	
	// Unified delete function for both partners and invitations
	function deleteEntity(entityType, entityId) {
		let confirmMessage = entityType === 'partner' 
			? 'Are you sure you want to delete this partner? This action cannot be undone.' 
			: 'Are you sure you want to delete this invitation? This action cannot be undone.';
		let deleteUrl = entityType === 'partner' 
			? `/partners/delete/${entityId}/` 
			: `/invitations/delete/${entityId}/`;
	
		if (!confirm(confirmMessage)) {
			return; // Early return if the user cancels the confirmation
		}
	
		fetch(deleteUrl, {
			method: 'POST',
			headers: {
				'X-CSRFToken': getCSRFToken(),
				'Content-Type': 'application/json',
			},
			credentials: 'same-origin',
		})
		.then(response => {
			if (!response.ok) {
				throw new Error('Network response was not ok.');
			}
			return response.json();
		})
		.then(data => {
			if (data.success) {
				const elementId = entityType === 'partner' ? `partner-${entityId}` : `invitation-${entityId}`;
				const element = document.getElementById(elementId);
				if (element) element.remove();
			} else {
				alert(`Error deleting ${entityType}.`);
			}
		})
		.catch(error => console.error('Error:', error));
	}
	
	// Function to get CSRF token from the cookie
	function getCSRFToken() {
		let csrfToken = null;
		if (document.cookie && document.cookie !== '') {
			const cookies = document.cookie.split(';');
			for (let i = 0; i < cookies.length; i++) {
				const cookie = cookies[i].trim();
				if (cookie.substring(0, 10) === ('csrftoken=')) {
					csrfToken = decodeURIComponent(cookie.substring(10));
					break;
				}
			}
		}
		return csrfToken;
	}
	</script>
	
{% endblock %}
{% endblock %}
