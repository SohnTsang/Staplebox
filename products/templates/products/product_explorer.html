{% extends "base_users.html" %}
{% load static %}
{% load custom_filters %}
{% load file_tags %}

{% block title %}Product Directory {% endblock %}

{% block css %}
<link rel="stylesheet" type="text/css" href="{% static 'exports/css/style.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'exports/css/modal.css' %}">

<style>



    a {
        cursor: pointer;
    }



    @media (min-width: 1055px) {
        #detail {
            max-width: 25%;
        }
        #left-explorer {
            max-width: 80%;
        }
    }


    @media (max-width: 1054px) {
        #detail {
            display: none !important;
        }
        #left-explorer{
            width: 100% !important;
        }
    }


    #right-panel-title {
        display: flex;
        align-items: center; /* Align items vertically in the center */
        
    }

    .name-container {
        margin-left: 8px; /* Adjust based on your icon's width or desired spacing */
        flex: 1; /* Allows the text container to take up the remaining space */
        white-space: normal; /* Ensure text wraps */
        word-wrap: break-word; /* Break the word to prevent overflow */
        overflow-wrap: break-word; /* Standard property for breaking long words to prevent overflow */
        hyphens: auto; /* Allow hyphenation of words in supported browsers */
    }


    .table-responsive {
        overflow-y: auto;
        display: block;
    }

    #information {
        position: relative;  /* This makes it the positioning context for the overlay */
        overflow-y: auto;
        display: block;
        min-height: 300px;  /* Ensure it has a minimum height for better UX */
    }

    /* Sticky table header */
    .table thead th {
        position: sticky;
        top: 0;
        z-index: 1; /* Ensures the header is above other content */
    }

    table td {
        overflow: hidden;         /* Hide overflowed content */
        white-space: nowrap;      /* Prevent text from wrapping to the next line */
        text-overflow: ellipsis;  /* Add ellipsis (...) at the end if the text overflows */
        max-width: 200px;         /* Set a max width for <td>, adjust as needed */
    }

    /* Ensure the table stretches to full width */
    .table {
        width: 100%;
        margin-bottom: 0rem; /* Adjust as necessary */
    }

    .truncate-name {
        max-width: 400px !important; /* Adjust based on your layout */
        width: 400px !important; /* Adjust based on your layout */
        min-width: 200px !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
    }

    .truncate-name a {
        vertical-align: middle;
    }


    .truncate-type {
        max-width: 250px !important; /* Adjust based on your layout */
        width: 250px !important; /* Adjust based on your layout */
        min-width: 100px !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
    }

    .truncate-version {
        max-width: 100px !important; /* Adjust based on your layout */
        width: 100px !important; /* Adjust based on your layout */
        min-width: 50px !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
    }

    .truncate-modified {
        max-width: 200px !important; /* Adjust based on your layout */
        width: 200px !important; /* Adjust based on your layout */
        min-width: 150px !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
    }

    .fixed-width-header {
        max-width: 50px !important; /* Adjust the width as needed */
        width: 50px !important; /* Adjust the width as needed */
        min-width: 50px !important;
    }

    .clickable-row td {
        text-decoration: none;
    }

    /* Optional: Remove text decoration on hover if desired */
    .clickable-row td:hover {
        text-decoration: none;
    }

    .breadcrumb-navigation:hover {
        background-color: #3d9dd433;
    }

    .breadcrumb-item {
    + .breadcrumb-item::before {
        content: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' fill='none' viewBox='0 0 20 20'%3E%3Cpath d='M10 17L15 12' stroke='%23454545' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M15 12L10 7' stroke='%23454545' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E") !important;
        color: #7d8daa;
    }
    }

    .checkbox-column {
        width: 40px !important; /* Adjust based on your design needs */
        max-width: 40px !important;
        min-width: 40px !important;
    }

    .highlighted-row {
        background-color: #4f96ee33 !important; /* Or any color you prefer */
    }

    .detail-item {
        margin-bottom: 0.6rem;
        padding-bottom: 0.5rem;
        padding-left: 1rem;
        padding-right: 1rem;
    }

    .detail-item:last-child {
        border-bottom: none;
        padding-bottom: 1rem;
    }

    .detail-item:first-child {
        padding-top: 1rem;
    }

    .detail-item strong, .access-item strong{
        font-size: 0.8rem;
        display: block;
        color: rgb(44, 44, 44);
        margin-bottom: .2rem;
        font-weight: 600;
    }

    .detail-item p {
        margin: 0;
        padding: 0;
        color: #474747;
        font-size: 0.9rem;
    }

    /* Column widths */
    th:nth-child(1), td:nth-child(1) {
        width: 3%;
        text-align: center;
    }

    th:nth-child(2), td:nth-child(2) {
        width: 27%;
    }

    th:nth-child(3), td:nth-child(3) {
        width: 17%;
    }

    th:nth-child(4), td:nth-child(4) {
        width: 15%;
    }

    th:nth-child(5), td:nth-child(5) {
        width: 10%;
    }

    th:nth-child(6), td:nth-child(6) {
        width: 8%;
        text-align: center;
    }

</style>
{% endblock %}

{% block content %}

<main>
    <div id="product-explorer" data-product-id="{{ signed_product_uuid }}" data-root-folder-id="{{ root_folder_id }}" class="">
        <input type="hidden" id="productId" value="{{ signed_product_uuid }}">
        <div class="background-overlay"></div>
        <div class="content-section">
            <div class="content-header-product-directory">
                <div class="header-top">
                    <div class="header-title-product">
                        <h3>{{ product.product_name }}</h3>
                        <div class="subheading">
                            <div><strong>Product Code:</strong> {{ product.product_code }}</div>
                            <div><strong>Product Type:</strong> {{ product.product_type }}</div>
                            <div><strong>Description:</strong> {{ product.product_description }}</div>
                        </div>
                        
                    </div>
                    {% if is_owner %}
                    <div class="button-group">
                        <div class="bulk-action-wrapper">
                            <button class="button-bulk-action" id="bulkActionButton" disabled>
                                Bulk Action
                                <img src="{% static 'images/table_icon/arrow_drop_down_24dp_FILL0_wght400_GRAD0_opsz24_333333.png' %}" alt="Visibility" class="icon-bulk-action" id="bulkActionIcon"> 
                            </button>
                            <div class="bulk-action-dropdown" id="bulkActionDropdown">
                                <a href="#" id="shareAccess" class="" data-product-id="{{ signed_product_uuid }}">Share</a>
                                <a href="#" id="deleteSelectedItems" class="bulk-action-delete text-danger">Delete</a>
                            </div>
                        </div>
                        <div class="action-button-container">
                            <button class="button-8 action-button-title" data-dropdown-target="ActionDropdown">
                                New
                            </button>
                            <div class="action-button-dropdown dropdown-content" id="ActionDropdown">
                                <a href="#" data-bs-toggle="modal" data-bs-target="#createFolderModal">New Folder</a>
                                <a href="#" data-bs-toggle="modal" id="openUploadModaProductlBtn" data-bs-target="#uploadDocumentModal">New Document</a>
                            </div>
                            <a href="{% url 'access_control:manage_access' product_uuid=signed_product_uuid %}" class="button-8">Access</a>
                        </div>
                    </div>
                    {% endif %}
                </div>
            
                <div class="header-bottom">

                    <div style="margin: 15px 0 5px 0;"><small>Folders: {{ total_folder_count }} | Documents: {{ total_document_count }}</small></div>
                    
                    <div class="filter-sort">
                        <form method="get" action="" id="filterSortForm">
                            <button type="reset" class="btn-reset" id="resetButton">Reset</button>
                            <input type="text" class="form-control" id="filter_value" name="filter_value" value="{{ request.GET.filter_value }}" placeholder="Search Partners" aria-label="Filter...">
                            <select class="form-select" name="filter_type" aria-label="Filter type">
                                <option value="company_name" {% if request.GET.filter_type == 'company_name' %}selected{% endif %}>Name</option>
                                <option value="email" {% if request.GET.filter_type == 'email' %}selected{% endif %}>Email</option>
                                <option value="role" {% if request.GET.filter_type == 'role' %}selected{% endif %}>Role</option>
                            </select>
                            <button type="submit" class="btn-submit">Apply</button>
                        </form>
                        {% if form.errors %}
                            {% for field in form %}
                                {% if field.errors %}
                                    <div id="alert-message" class="alert alert-danger fw-bold" role="alert">
                                        {{ field.errors|first }}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="breadcrumb-section" style="margin: 15px 0 5px 0; padding-left:2px;">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        {% for breadcrumb in breadcrumbs %}
                        <li class="breadcrumb-item">
                            {% if forloop.last %}
                            <span class="p-2 h6 fw-bold">{{ breadcrumb.name }}</span>
                            {% else %}
                            <a href="{% url 'products:product_explorer_folder' product_uuid=signed_product_uuid folder_uuid=breadcrumb.id %}" class="breadcrumb-navigation">{{ breadcrumb.name }}</a>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ol>
                </nav>
            </div>

            <div class="table-container-2" style="margin-top: 0px;">
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllItems"></th>
                            <th>Name <span class="sort-icon desc inactive"></span></th>
                            <th>Category <span class="sort-icon desc inactive"></span></th>
                            <th>Date Modified <span class="sort-icon desc inactive"></span></th>
                            <th>Version <span class="sort-icon desc inactive"></span></th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if subfolders or documents %}
                            <!-- Folders -->
                            {% for folder in subfolders %}
                            <tr class="clickable-td" data-href="{% url 'products:product_explorer_folder' product_uuid=signed_product_uuid folder_uuid=folder.uuid %}" data-type="folder" data-id="{{ folder.uuid }}">
                                <td class="checkbox-cell" style="cursor: default;"><input class="folder-checkbox" type="checkbox"></td>
                                <td class="name-cell">
                                    <img src="{% static 'images/table_icon/folder.png' %}" alt="File Icon" class="folder-icon">
                                    <span class="">{{ folder.name }}</span>
                                </td>
                                <td class="text-muted-weight">Folder</td>
                                <td class="text-muted-weight">{{ folder.updated_at|date:"Y-m-d H:i" }}</td>
                                <td class="text-muted-weight ps-4">—</td>
                                <td class="actions">
                                    <div class="action-button-container">
                                        <button class="action-button" data-dropdown-target="actionDropdown{{ forloop.counter }}">
                                            <img src="{% static 'images/table_icon/more_vert_24dp_FILL0_wght400_GRAD0_opsz24_333333.png' %}" alt="Actions">
                                        </button>
                                        <div class="action-button-dropdown dropdown-content" id="actionDropdown{{ forloop.counter }}">
                                            <a href="#" data-bs-toggle="modal" data-bs-target="#accessControlModal" data-folder-id="{{ folder.uuid }}" data-product-id="{{ signed_product_uuid }}">Share</a>
                                            <!--<a href="#" data-bs-toggle="modal" data-bs-target="#editFolderModal" data-folder-id="{{ folder.uuid }}" data-product-id="{{ signed_product_uuid }}">Edit</a>-->
                                            <a href="#" data-bs-toggle="modal" data-bs-target="#editFolderModal" data-folder-id="{{ folder.uuid }}" data-product-id="{{ signed_product_uuid }}">Edit</a>

                                            <a href="#" data-bs-toggle="modal" data-bs-target="#moveEntityModal" data-entity-type="folder" data-entity-id="{{ folder.uuid }}" data-product-id="{{ signed_product_uuid }}" data-moving-folder-id="{{ folder.uuid }}" data-current-folder-id="{{ folder.parent }}" data-url="{% url 'products:move_entity' product_uuid=signed_product_uuid entity_type='folder' entity_uuid=folder.uuid current_folder_uuid=folder.parent %}">Move</a>
                                            
                                            <hr class="dropdown-divider">
                                            <form class="delete-folder-form" data-id="{{ folder.uuid }}" method="post">
                                                {% csrf_token %}
                                                <button type="submit" class="text-danger">Delete</button>
                                            </form>

                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                            
                            <!-- Documents -->
                            {% for document in documents %}
                            <tr class="non-clickable-tr" data-document-id="{{ document.uuid }}" data-id="{{ document.uuid }}" data-type="document">
                                <td class="checkbox-cell" style="cursor: default;"><input class="document-checkbox" type="checkbox"></td>
                                <td class="name-cell">
                                    <img src="{{ document.name|file_icon }}" alt="File Icon" class="file-icon">
                                    <span class="file-name-table" style="color: black !important">
                                        {{ document.name }}
                                    </span>
                                </td>
                                <td class="text-muted-weight">{# document.document_type.type_name #}Document</td>
                                <td class="text-muted-weight">{{ document.updated_at|date:"Y-m-d H:i" }}</td>
                                <td class="text-muted-weight ps-4">{{ document.version }}</td>
                                <td class="actions">
                                    <div class="action-button-container">
                                        <button class="action-button">
                                            <img src="{% static 'images/table_icon/more_vert_24dp_FILL0_wght400_GRAD0_opsz24_333333.png' %}" alt="Actions">
                                        </button>
                                        <div class="action-button-dropdown dropdown-content">
                                            <a href="#" data-bs-toggle="modal" data-bs-target="#accessControlModal" data-document-id="{{ document.uuid }}" data-product-id="{{ signed_product_uuid }}">Share</a>
                                            <a href="#" data-bs-toggle="modal" data-bs-target="#editDocumentModal" data-document-id="{{ document.uuid }}">Edit</a>
                                            <a href="#" data-bs-toggle="modal" data-bs-target="#commentModal" data-document-id="{{ document.uuid }}">Comment</a>
                                            <a href="#" data-bs-toggle="modal" data-bs-target="#moveEntityModal" data-entity-type="document" data-entity-id="{{ document.uuid }}" data-product-id="{{ signed_product_uuid }}" data-current-folder-id="{{ document.folder.uuid }}" data-url="{% url 'products:move_entity' product_uuid=signed_product_uuid entity_type='document' entity_uuid=document.uuid current_folder_uuid=document.folder %}">Move</a>
                                            <a href="#" data-bs-toggle="modal" data-bs-target="#updateDocumentModal" data-document-id="{{ document.uuid }}">Upload New Version</a>
                                            <a href="#" data-bs-toggle="modal" data-bs-target="#documentVersionsModal" data-document-id="{{ document.uuid }}">Version History</a>
                                            <a href="{% url 'documents:download_document' document.uuid %}">Download</a>
                                            <hr class="dropdown-divider">
                                            <form class="delete-document-form" data-id="{{ document.uuid }}" method="post">
                                                {% csrf_token %}
                                                <button type="submit" class="text-danger">Delete</button>
                                            </form>                                            
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="6">No Folders or Documents Added</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>

{% include "modal/upload_document_modal.html" %}
{% include "modal/create_folder_modal.html" %}
{% include "modal/edit_folder_modal.html" %}
{% include "modal/remove_access_confirm_modal.html" %}
{% include "modal/edit_document_modal.html" %}
{% include "modal/document_version_modal.html" %}
{% include "modal/update_document_modal.html" %}
{% include "modal/comment_modal.html" %}
{% include "modal/move_entity_modal.html" %}
{% include "modal/access_control_modal.html" %}

{% block javascript %}

<!--<script src="{% static 'products/js/product_explorer.js' %}"></script>-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script>
    const productId = '{{ signed_product_uuid }}'; // Make sure this is rendered server-side or appropriately defined somewhere accessible
</script>

<script>

document.addEventListener('DOMContentLoaded', function() {
    function activateAllPartnersTab() {
        // Find the tab with 'data-tab="AllPartners"'
        var allPartnersTab = document.querySelector('div[data-tab="AllPartners"]');
        // Add the 'active' class to the 'All Partners' tab
        allPartnersTab.classList.add('active');
    }

    document.getElementById('shareAccess').addEventListener('click', function(event) {
        event.preventDefault();

        const modalSubTitle = document.getElementById('modalSubTitle'); 

        

        const selectedFolders = Array.from(document.querySelectorAll('.folder-checkbox:checked')).map(cb => ({
            id: cb.closest('tr').dataset.id,
            type: 'folder'
        }));

        const selectedDocuments = Array.from(document.querySelectorAll('.document-checkbox:checked')).map(cb => ({
            id: cb.closest('tr').dataset.id,
            type: 'document'
        }));

        

        const selectedItems = selectedFolders.concat(selectedDocuments);
        if (selectedItems.length === 0) {
            showMessage('Please select at least one item to share.', 'error');
            return;
        }

        const itemIds = selectedItems.map(item => item.id).join(',');
        const itemTypes = selectedItems.map(item => item.type).join(',');

        // Set the item_ids and item_types values in the modal
        const modal = document.getElementById('accessControlModal');
        modal.querySelector('#item_id').value = itemIds;
        modal.querySelector('#item_type').value = itemTypes;

        if (selectedItems.length > 0 && event.target.id === 'shareAccess') {
            activateAllPartnersTab();

            if (selectedFolders.length > 0 || selectedDocuments.length > 0) {
                modalSubTitle.textContent = `${selectedFolders.length + selectedDocuments.length} item(s) selected for bulk share`;
            } else {
                modalSubTitle.textContent = 'No items selected';
            }

            // Hide the "Partners with Access" tab and content
            document.getElementById('partnersWithAccessTab').style.display = 'none';
            document.getElementById('PartnersWithAccess').style.display = 'none';

            // Fetch and display all partners in the "All Partners" tab
            fetch(`/access_control/get_all_partners/`)
                .then(response => response.json())
                .then(data => {
                    const partnersList = document.getElementById('partnersList').querySelector('.partners-content');
                    partnersList.innerHTML = ''; // Clear previous entries

                    if (Array.isArray(data) && data.length === 0) {
                        partnersList.innerHTML = '<small>No partners available</small>';
                    } else if (Array.isArray(data)) {
                        data.forEach(partner => {
                            const li = document.createElement('li');
                            li.className = 'partner-info';
                            li.setAttribute('data-partner-id', partner.partner_id);
                            li.innerHTML = `
                                <div class="partner-name">${partner.company_name}</div>
                                <div class="partner-role">${partner.company_role}</div>
                            `;
                            partnersList.appendChild(li);

                            li.addEventListener('click', function() {
                                this.classList.toggle('selected');
                            });
                        });
                    } else {
                        console.error('Unexpected data format:', data);
                    }

                    // Hide loading spinner
                    const allPartnersLoadingOverlay = modal.querySelector('.tab-content-access .loading-overlay');
                    if (allPartnersLoadingOverlay) {
                        allPartnersLoadingOverlay.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error loading partner data:', error);
                    // Hide loading spinner in case of error
                    const allPartnersLoadingOverlay = modal.querySelector('.tab-content-access .loading-overlay');
                    if (allPartnersLoadingOverlay) {
                        allPartnersLoadingOverlay.style.display = 'none';
                    }
                });
            }
            modal.style.display = 'block';
        });
        // Close the modal when clicking the cancel button or outside the modal
        document.querySelectorAll('.cancel-btn, .modal').forEach(element => {
            element.addEventListener('click', function(event) {
                if (event.target.classList.contains('cancel-btn') || event.target.classList.contains('modal')) {
                    document.getElementById('accessControlModal').style.display = 'none';
                }
            });
        });
    });

</script>
    

<script>
// Function to delete selected items
document.addEventListener('DOMContentLoaded', function () {
    const selectAllItems = document.getElementById('selectAllItems');
    const checkboxes = document.querySelectorAll('tbody input[type="checkbox"]');
    const bulkActionButton = document.getElementById('bulkActionButton');
    const bulkActionDropdown = document.getElementById('bulkActionDropdown');
    const bulkActionIcon = document.getElementById('bulkActionIcon');
    const deleteSelectedItems = document.getElementById('deleteSelectedItems'); // for deletion on documents and folders in product_explorer.html

    selectAllItems.addEventListener('change', function () {
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        toggleBulkActionButton();
    });

    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', toggleBulkActionButton);
    });

    function toggleBulkActionButton() {
        const anyChecked = Array.from(checkboxes).some(c => c.checked);
        bulkActionButton.disabled = !anyChecked;
        if (anyChecked) {
            bulkActionButton.classList.add('enabled');
            bulkActionButton.style.cursor = 'pointer';
        } else {
            bulkActionButton.classList.remove('enabled');
            bulkActionButton.style.cursor = 'initial';
        }
    }

    toggleBulkActionButton();

    bulkActionButton.addEventListener('click', function (event) {
        event.preventDefault();
        if (!bulkActionButton.disabled) {
            bulkActionDropdown.classList.toggle('show');
            if (bulkActionDropdown.classList.contains('show')) {
                bulkActionIcon.src = '/static/images/table_icon/arrow_drop_up_24dp_FILL0_wght400_GRAD0_opsz24_333333.png';
            } else {
                bulkActionIcon.src = '/static/images/table_icon/arrow_drop_down_24dp_FILL0_wght400_GRAD0_opsz24_333333.png';
            }
        }
    });

    window.onclick = function (event) {
        if (!event.target.matches('.button-bulk-action') && !event.target.closest('.bulk-action-wrapper')) {
            if (bulkActionDropdown.classList.contains('show')) {
                bulkActionDropdown.classList.remove('show');
                bulkActionIcon.src = "/static/images/table_icon/arrow_drop_down_24dp_FILL0_wght400_GRAD0_opsz24_333333.png";
            }
        }
    };

    deleteSelectedItems.addEventListener('click', async function () {
        if (bulkActionButton.disabled) {
            return;
        }

        const selectedFolders = Array.from(checkboxes)
            .filter(checkbox => checkbox.checked && checkbox.closest('tr').getAttribute('data-type') === 'folder')
            .map(checkbox => checkbox.closest('tr').getAttribute('data-id'));
        console.log(selectedFolders)
        const selectedDocuments = Array.from(checkboxes)
            .filter(checkbox => checkbox.checked && checkbox.closest('tr').getAttribute('data-type') === 'document')
            .map(checkbox => checkbox.closest('tr').getAttribute('data-id'));

        const confirmation = await showRemoveModal('Are you sure you want to delete the selected items?');

        if (confirmation) {
            if (selectedFolders.length > 0) {
                fetch(`/folder/delete_folders/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ folder_ids: selectedFolders })
                })
                .then(handleResponse)
                .catch(handleError);
            }

            if (selectedDocuments.length > 0) {
                fetch(`/documents/delete_documents/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ document_ids: selectedDocuments })
                })
                .then(handleResponse)
                .catch(handleError);
            }
        }
    });

    function handleResponse(response) {
        if (response.ok) {
            return response.json().then(data => {
                setSessionMessage(data.detail || 'Operation successful.', 'success');
                location.reload();
            }).catch(() => {
                setSessionMessage('Operation successful.', 'success');
                location.reload();
            });
        } else {
            throw new Error('Network response was not ok.');
        }
    }

    function handleError(error) {
        setSessionMessage('There was an error processing your request.', 'error');
        location.reload();
    }

    document.querySelectorAll('.delete-folder-form').forEach(form => {
        form.addEventListener('submit', async function (event) {
            event.preventDefault();
            const confirmation = await showRemoveModal('Are you sure you want to delete the folder?');

            if (confirmation) {
                fetch(`/folder/delete_folders/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ folder_ids: [form.getAttribute('data-id')] })
                })
                .then(handleResponse)
                .catch(handleError);
            }
        });
    });

    document.querySelectorAll('.delete-document-form').forEach(form => {
        form.addEventListener('submit', async function (event) {
            event.preventDefault();
            const confirmation = await showRemoveModal('Are you sure you want to delete the document?');

            if (confirmation) {
                fetch(`/documents/delete_documents/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ document_ids: [form.getAttribute('data-id')] })
                })
                .then(handleResponse)
                .catch(handleError);
            }
        });
    });

    // Function to handle row clicks except on the action button and actions cell
    document.querySelectorAll('.clickable-td').forEach(row => {
        row.addEventListener('click', function(event) {
            // Check if the click was within the checkbox, dropdown button, or actions cell
            if (!event.target.closest('.actions, .actions *, .action-button, .action-button *, input[type="checkbox"]')) {
                window.location.href = this.getAttribute('data-href');
            }
        });
    });

    // Prevent propagation of the click event from the checkbox to the row
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('click', function(event) {
            event.stopPropagation();
        });
    });

    // Add event listener to handle clicks on the parent <td> of the checkbox
    document.querySelectorAll('.checkbox-cell').forEach(cell => {
        cell.addEventListener('click', function(event) {
            const checkbox = this.querySelector('input[type="checkbox"]');
            if (event.target !== checkbox) {
                checkbox.checked = !checkbox.checked;
                toggleBulkActionButton();
                event.stopPropagation();
            }
        });
    });

});


</script>

<!-- Upload Document Modal -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const csrftoken = getCookie('csrftoken');
    let validFilesMap = new Map();
    let invalidFileCount = 0;

    const modal = document.getElementById('uploadDocumentModal');
    const uploadZone = document.getElementById('uploadZoneDocument');
    const uploadedFiles = document.getElementById('uploadedFilesDocument');
    const cancelBtn = document.getElementById('cancelUploadBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const openUploadModaProductlBtn = document.getElementById('openUploadModaProductlBtn');
    const productId = "{{ signed_product_uuid }}";
    const folderId = "{{ signed_current_folder_uuid }}";

    function updateUploadButtonState() {
        uploadBtn.disabled = invalidFileCount > 0 || validFilesMap.size === 0;
    }

    function formatFileSize(sizeInBytes) {
        if (sizeInBytes < 1024) return "1 KB";
        let sizeInKb = sizeInBytes / 1024.0;
        const units = ['KB', 'MB', 'GB', 'TB', 'PB'];
        for (let unit of units) {
            if (sizeInKb < 1024.0) return `${sizeInKb.toFixed(1)} ${unit}`;
            sizeInKb /= 1024.0;
        }
        return `${sizeInKb.toFixed(1)} PB`;
    }

    function getFileTypeIcon(fileName) {
        const extension = fileName.split('.').pop().toLowerCase();
        const iconMap = {
            'png': '{% static "images/table_icon/png.png" %}',
            'csv': '{% static "images/table_icon/csv.png" %}',
            'zip': '{% static "images/table_icon/zip.png" %}',
            'jpg': '{% static "images/table_icon/jpg.png" %}',
            'pdf': '{% static "images/table_icon/pdf.png" %}',
            'doc': '{% static "images/table_icon/doc.png" %}',
            'xls': '{% static "images/table_icon/xls.png" %}',
            'ppt': '{% static "images/table_icon/ppt.png" %}',
            'txt': '{% static "images/table_icon/txt.png" %}',
            'default': '{% static "images/table_icon/file.png" %}'
        };
        return iconMap[extension] || iconMap['default'];
    }

    function handleFiles(files) {
        Array.from(files).forEach(file => {
            const formattedSize = formatFileSize(file.size);
            const li = document.createElement('li');
            li.innerHTML = `<div class="file-info">
                                <img src="${getFileTypeIcon(file.name)}" alt="${file.name.split('.').pop()}" class="file-icon">
                                <span class="file-name">${file.name}</span>
                                <span class="file-size">${formattedSize}</span>
                                <button class="remove-document-btn">Delete</button>
                            </div>
                            <progress class="upload-progress" value="0" max="100"></progress>`;
            uploadedFiles.appendChild(li);

            const progressBar = li.querySelector('.upload-progress');
            if (file.size <= 10 * 1024 * 1024) {
                validFilesMap.set(file, li);
            } else {
                li.style.border = "1px solid red";
                li.style.backgroundColor = "#ffcccc88";
                invalidFileCount++;
            }

            let reader = new FileReader();
            reader.onload = () => {
                progressBar.value = 100;
                progressBar.style.background = "linear-gradient(to right, #4caf50 100%, #f3f3f3 0%)";
            };
            reader.readAsDataURL(file);

            li.querySelector('.remove-document-btn').addEventListener('click', () => {
                if (file.size > 10 * 1024 * 1024) {
                    invalidFileCount--;
                } else {
                    validFilesMap.delete(file);
                }
                uploadedFiles.removeChild(li);
                updateUploadButtonState();
            });
        });
        updateUploadButtonState();
    }

    function setupFileHandlers() {
        uploadZone.addEventListener('click', function () {
            var fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.multiple = true;
            fileInput.style.display = 'none';
            fileInput.addEventListener('change', function () {
                handleFiles(fileInput.files);
            });
            fileInput.click();
        });

        uploadZone.addEventListener('dragover', function (e) {
            e.preventDefault();
            e.stopPropagation();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', function (e) {
            e.preventDefault();
            e.stopPropagation();
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', function (e) {
            e.preventDefault();
            e.stopPropagation();
            uploadZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
    }

    openUploadModaProductlBtn.addEventListener('click', function () {
        var myModal = new bootstrap.Modal(modal);
        myModal.show();
        validFilesMap.clear();
        invalidFileCount = 0;
        updateUploadButtonState();
    });

    cancelBtn.addEventListener('click', function () {
        var myModal = new bootstrap.Modal(modal);
        myModal.hide();
        validFilesMap.clear();
        invalidFileCount = 0;
        uploadedFiles.innerHTML = '';
        updateUploadButtonState();
    });

    uploadBtn.addEventListener('click', function () {
        const xhr = new XMLHttpRequest();
        const formData = new FormData();
        validFilesMap.forEach((li, file) => {
            formData.append('document_files', file);
            formData.append('document_types', li.querySelector('.document-type-select')?.value || '');
            formData.append('comments', li.querySelector('.comment-textarea')?.value || '');
        });
        xhr.open('POST', `/products/${productId}/folders/${folderId}/upload_document/`, true);
        xhr.setRequestHeader('X-CSRFToken', csrftoken);

        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200 || xhr.status === 201) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response.errors) {
                            response.errors.forEach(error => {
                                showMessage(`Error with file ${error.file}: ${JSON.stringify(error.errors)}`, 'error');
                            });
                        } else {
                            setSessionMessage(response.detail, 'success');
                            location.reload();  // Make sure this only happens after a successful response
                        }
                    } catch (e) {
                        showMessage('Invalid response from server.', 'error');
                        console.error('Error parsing response:', e);
                    }
                } else {
                    showMessage('There was an error processing your request.', 'error');
                    console.error('Server returned status:', xhr.status, xhr.responseText);
                }
            }
        };
        xhr.onerror = function () {
            showMessage('There was an error processing your request.', 'error');
            console.error('Request failed');
        };

        xhr.send(formData);
    });

    setupFileHandlers();
});
</script>

<!-- Create Folder Modal-->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const createFolderForm = document.getElementById('create-folder-form-modal');
        const createFolderModalInstance = new bootstrap.Modal(document.getElementById('createFolderModal'));

        createFolderForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const folderName = document.getElementById('folderNameModal').value;
            const productId = document.getElementById('product-explorer').dataset.productId;
            
            formData.append('product', productId);
            const parentFolderId = document.getElementById('parentFolderIdModal').value;
            if (parentFolderId) {
                formData.append('parent_id', parentFolderId);
            }


            const jsonData = {};
            formData.forEach((value, key) => {
                jsonData[key] = value;
            });

            fetch(`/products/${productId}/create_folder/`, {
                method: 'POST',
                body: JSON.stringify(jsonData),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                credentials: 'include',
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    setSessionMessage('Folder created', 'success');
                    location.reload(); // Reload the page
                } else {
                    showMessage('Error creating folder: ' + data.errors.join(', '), 'error');
                }
            })
            .catch(error => {
                showMessage('Failed to create folder due to a network error.', 'error');
            });
        });
    });

</script>

<!-- move entity modal -->
<script>
let movingFolderId = null;

document.addEventListener('DOMContentLoaded', function() {
    const moveEntityModal = document.getElementById('moveEntityModal'); // Get the modal by its ID

    $('#moveEntityModal').on('show.bs.modal', function(event) {
        const button = $(event.relatedTarget); // Button that triggered the modal
        const modal = $(this);
        const entityType = button.data('entity-type');
        if (entityType !== 'folder') {
            movingFolderId = null;
        } 
        else {
            movingFolderId = button.data('moving-folder-id');
        }

        const url = button.data('url'); // Ensure this attribute is passed correctly
        $.ajax({
            url: url,
            success: function(response) {
                modal.find('.modal-body').html(response.html);
                modal.find('.action-form input[name="moving_folder_id"]').val(movingFolderId); // Set the value for the hidden input field in form
            },
            error: function() {
                modal.find('.modal-body').html('<p>Error loading information.</p>');
            }
        });
    });

    // Handling form submission within the modal
    $(moveEntityModal).on('submit', '.action-form', function(e) {
        e.preventDefault();
        var form = $(this);
        $.ajax({
            type: 'POST',
            url: form.attr('action'),
            data: form.serialize(),
            headers: {'X-CSRFToken': getCookie('csrftoken')},
            success: function(response) {
                if (response.success) {
                    setSessionMessage(response.message, 'success');
                    location.reload();
                } else {
                    showMessage(response.error, 'error');
                }
            },
            error: function(xhr) {
                var errorMessage = 'Failed to move due to a network error.';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                } else if (xhr.responseJSON && xhr.responseJSON.errors) {
                    var errors = xhr.responseJSON.errors;
                    errorMessage = '';
                    if (Array.isArray(errors)) {
                        errorMessage = errors.join('<br>');
                    } else if (typeof errors === 'object') {
                        Object.keys(errors).forEach(function(key) {
                            errorMessage += errors[key] + '<br>';
                        });
                    } else {
                        errorMessage = errors;
                    }
                }
                showMessage(errorMessage, 'error');
            }
        });
    });

    // Click event handler to open folders within the modal
    moveEntityModal.addEventListener('click', function(event) {
        const target = event.target;
        if (target.classList.contains('open-folder') || target.classList.contains('breadcrumb-link')) {
            const folderId = target.dataset.folderId;
            if (!folderId || !productId) {
                console.error('Folder ID or Product ID is missing!');
                return;
            }

            const url = `/products/${productId}/explorer/folder/${folderId}/content/?moving_folder_id=${movingFolderId}`;
            
            fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                const contentSection = moveEntityModal.querySelector('.content-section');
                contentSection.innerHTML = data.html;
                updateBreadcrumbs(data.breadcrumbs, moveEntityModal);
                moveEntityModal.querySelector('input[name="target_folder_id"]').value = folderId; // Update the target_folder_id input

            })
            .catch(error => {
                console.error('Error loading folder contents:', error);
            });
        }
    });

    function updateBreadcrumbs(breadcrumbs, modalScope) {
        const breadcrumbContainer = modalScope.querySelector('.breadcrumb-container ol');
        breadcrumbContainer.innerHTML = ''; // Clear existing breadcrumbs
        breadcrumbs.forEach((breadcrumb, index) => {
            const li = document.createElement('li');
            li.className = 'breadcrumb-item';
            if (index === breadcrumbs.length - 1) {
                const span = document.createElement('span');
                span.className = 'p-2 h6 fw-bold small';
                span.textContent = breadcrumb.name;
                li.appendChild(span);
            } else {
                const a = document.createElement('a');
                a.href = "#";
                a.textContent = breadcrumb.name;
                a.className = 'breadcrumb-link breadcrumb-navigation';
                a.dataset.folderId = breadcrumb.id;
                a.dataset.productId = productId; // Assuming productId is globally available or correctly passed
                a.dataset.movingFolderId = movingFolderId; // Moving folder ID needs to be captured dynamically
                li.appendChild(a);
            }
            breadcrumbContainer.appendChild(li);
        });
    }

});
</script>

<!-- View and Edit Comment Modal-->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var commentModal = document.getElementById('commentModal');
        commentModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var documentId = button.getAttribute('data-document-id');
            var modalBody = document.querySelector('#commentModal .modal-body');
            var tableBody = document.querySelector('#commentsTable tbody');

            modalBody.dataset.documentId = documentId;

            fetch(`/documents/document/ajax/comments/${documentId}/`)
                .then(response => response.json())
                .then(data => {
                    tableBody.innerHTML = ''; // Clear previous entries
                    data.versions.forEach(function(version) {
                        var row = document.createElement('tr'); // Create a new table row
                        row.innerHTML = `
                            <td class=""><span style="margin-left:20px;">${version.version}</span></td>
                            <td id="modified-time-${version.version}" class="">${version.modified}</td>
                            <td class="">${version.uploader}</td>
                            <td id="comment-text-${version.version}" class="text-start align-middle">${version.comment}</td>
                            <td id="" class="" style="text-align:center;" >${version.is_editable ? `<button class="btn-edit-save" onclick="editComment('${documentId}', ${version.version})">Edit</button>` : ''}</td>
                        `;
                        tableBody.appendChild(row); // Append the row to the table body
                    });
                })
                .catch(error => console.error('Error loading comments:', error));
        });
    });

    function editComment(documentId, versionNumber) {
        const commentCell = document.getElementById(`comment-text-${versionNumber}`);
        const originalComment = commentCell.textContent; // Get the current comment text
        const buttonCell = commentCell.nextElementSibling; // Assuming the button is next to the comment cell
        const originalHeight = commentCell.offsetHeight; // Get the original height of the comment cell

        commentCell.innerHTML = `<textarea class="form-control-comment form-control-sm">${originalComment}</textarea>`;
        buttonCell.innerHTML = `<button class="btn-edit-save" onclick="saveComment('${documentId}', ${versionNumber})">Save</button>`;
    }

    function saveComment(documentId, versionNumber) {
        const commentCell = document.getElementById(`comment-text-${versionNumber}`);
        const textarea = commentCell.querySelector('textarea');
        const newText = textarea.value;

        fetch(`/documents/document/${documentId}/edit_comment/version/${versionNumber}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `comments=${encodeURIComponent(newText)}`
        })
        .then(response => response.json()) // Ensure server sends back JSON
        .then(data => {
            if (data.success) {
                commentCell.innerHTML = newText; // Update the comment cell with new text
                const buttonCell = commentCell.nextElementSibling; // Get the cell containing the button
                const modifiedTimeCell = document.querySelector(`#modified-time-${versionNumber}`);
                modifiedTimeCell.innerText = data.modified;

                buttonCell.innerHTML = `<button class="btn-edit-save" onclick="editComment('${documentId}', ${versionNumber})">Edit</button>`;
            } else {
                console.error(data.error || 'Failed to update comment. Please try again.');
                showMessage('Failed to update comment. Please try again.', 'error');
            }
        })
        .catch(error => {
            showMessage(error, 'error');
        });
    }

</script>

<!-- Update Document modal -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        $('#updateDocumentModal').on('show.bs.modal', function(event) {
            var button = $(event.relatedTarget);  // Button that triggered the modal
            var documentId = button.data('document-id');  // Use jQuery's data method to access data attributes

            var modal = $(this);
            modal.find('#product_id').val(documentId);  // Set the hidden input value to the document ID
        });

        var updateForm = document.getElementById('updateDocumentForm');
        updateForm.addEventListener('submit', function(event) {
            event.preventDefault();
            var formData = new FormData(updateForm);
            var documentId = updateForm.querySelector('#product_id').value;  // Ensure correct value assignment

            fetch(`/documents/document/update/${documentId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')  // Ensure CSRF token is included
                },
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showMessage('Error updating document: ' + Object.values(data.errors).join(', '), 'error');
                } else {
                    setSessionMessage('Document updated', 'success');
                    location.reload();
                }
            })
            .catch(error => {
                showMessage('Failed to update document due to a network error.', 'error');
            });
            
        });
    });
</script>



<!-- document version modal -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var versionsModal = document.getElementById('documentVersionsModal');

        versionsModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var documentId = button.getAttribute('data-document-id');
            var versionList = document.getElementById('versionList');

            fetch(`/documents/document/ajax/versions/${documentId}/`)
                .then(response => response.json())
                .then(data => {
                    versionList.innerHTML = ''; // Clear previous entries
                    if (data.is_owner) {
                        // Render owner-specific view
                        data.versions.forEach(function(version) {
                            var row = document.createElement('tr');
                            row.innerHTML = `
                                <td class="text-center align-middle">${version.version}</td>
                                <td class="text-start align-middle">${version.filename}</td>
                                <td class="text-center align-middle">${version.modified}</td>
                                <td class="text-center align-middle">${version.uploader}</td>
                                <td class="" style="text-align:center;">
                                    <a href="${version.download_url}" class="badge bg-primary-custom rounded-pill p-2 text-white align-middle">
                                    <button class="action-button">
                                        <img src="{% static 'images/table_icon/download_333333.png' %}" alt="Actions">
                                    </button>
                                    </a>
                                </td>
                            `;
                            versionList.appendChild(row);
                        });
                    } else {
                        // Render general user view
                        data.versions.forEach(function(version) {
                            var row = document.createElement('tr');
                            row.innerHTML = `
                                <td class="text-center">${version.version}</td>
                                <td class="text-start">${version.filename}</td>
                                <td class="text-center">${version.modified}</td>
                                <td class="text-center">${version.uploader}</td>
                                <td class="text-center align-middle"><a href="${version.download_url}" class="badge bg-primary-custom rounded-pill p-2 text-white align-middle">Download</a></td>
                            `;
                            versionList.appendChild(row);
                        });
                    }
                })
            .catch(error => console.error('Error loading versions:', error));
        });
    });
</script>

<!-- edit document modal -->
<script>

    document.addEventListener('DOMContentLoaded', function () {
        var editModal = document.getElementById('editDocumentModal');
        editModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget; // Button that triggered the modal
            var documentId = button.getAttribute('data-document-id'); // Extract info from data-* attributes
            var form = document.getElementById('editDocumentForm');
            form.action = `/documents/document/edit/${documentId}/`; // Update the form's action attribute

            // Fetch document details via AJAX
            fetch(`/documents/document/ajax/${documentId}/`)
                .then(response => response.json())
                .then(data => {
                    var documentTypeSelect = document.getElementById('id_document_type');
                    documentTypeSelect.innerHTML = ''; // Clear previous options

                    // Populate document types
                    data.document_types.forEach(function(type) {
                        var option = new Option(type.type_name, type.id); // Corrected from type.name to type.type_name
                        documentTypeSelect.add(option);
                    });

                    // Set the selected value
                    documentTypeSelect.value = data.document_type_id;

                    document.getElementById('id_original_filename').value = data.original_filename;
                    document.getElementById('id_comments').value = data.comments; // Use .value for textarea to ensure text is set correctly
                })
                .catch(error => console.error('Error loading document data:', error));
        });

        var form = document.getElementById('editDocumentForm'); // Define form here
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            var data = {
                'document_type': document.getElementById('id_document_type').value,
                'original_filename': document.getElementById('id_original_filename').value,
                'comments': document.getElementById('id_comments').value
            };

            fetch(form.action, {
                method: 'POST',
                body: JSON.stringify(data),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                credentials: 'include',
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    setSessionMessage('Document updated', 'success');
                    location.reload();
                } else {
                    showMessage('Error updating document: ' + Object.values(data.errors).join(', '), 'error');
                }
            })
            .catch(error => {
                showMessage('Failed to update document due to a network error.', 'error');
            });
        });
    });
</script>

<!-- remove access modal -->
<script>
    
    function removeAccess(partnerId, entityType, entityId, productId) {
        document.getElementById('confirmationModal').style.display = 'block';

        document.getElementById('confirmBtn').onclick = function() {
            const url = `/access_control/remove_specific_access/${productId}/${entityType}/${entityId}/`;
            const data = {
                'csrfmiddlewaretoken': '{{ csrf_token }}',
                'partner_id': partnerId
            };
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    sessionStorage.setItem('message', 'Access removed');
                    sessionStorage.setItem('messageType', 'success');
                } else {
                    sessionStorage.setItem('message', 'Failed to remove access. Please try again.');
                    sessionStorage.setItem('messageType', 'error');
                }
            })
            .catch(error => {
                sessionStorage.setItem('message', 'Error connecting to the server. Please try again.');
                sessionStorage.setItem('messageType', 'error');
            })
            .finally(() => {
                location.reload(); // Reload the page to display the message
                document.getElementById('confirmationModal').style.display = 'none';
            });
        };

        

        document.querySelectorAll('.close-modal-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.getElementById('confirmationModal').style.display = 'none';
            });
        });
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        const message = sessionStorage.getItem('message');
        const messageType = sessionStorage.getItem('messageType');
    
        if (message && messageType) {
            showMessage(message, messageType); // Use your existing showMessage function
            sessionStorage.removeItem('message'); // Clear the message
            sessionStorage.removeItem('messageType'); // Clear the message type
        }
    });

</script>

<!-- edit folder mdoal -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const editModal = document.getElementById('editFolderModal');
        editModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget; // Button that triggered the modal
            var folderId = button.getAttribute('data-folder-id');
            var productId = button.getAttribute('data-product-id');
            var form = document.getElementById('editFolderForm');

            fetch(`/folder/get_folder_data/?folder_id=${folderId}&product_id=${productId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.folder_id && data.product_id) {
                        form.action = `/folder/${data.product_id}/explorer/${data.folder_id}/edit_folder/`;

                        fetch(`/folder/ajax/${data.product_id}/${data.folder_id}/`)
                            .then(response => response.json())
                            .then(data => {
                                const nameInput = document.getElementById('id_name');
                                nameInput.value = data.name;
                                nameInput.select();
                                document.getElementById('id_parent').value = data.parent_id;
                            })
                            .catch(error => console.error('Error loading folder data:', error));
                    } else {
                        console.error('Folder ID or Product ID is null');
                    }
                })
                .catch(error => console.error('Error fetching folder data:', error));

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);

                // Handle submission via JSON
                const jsonData = {};
                formData.forEach((value, key) => {
                    jsonData[key] = value;
                });

                fetch(form.action, {
                    method: 'POST',
                    body: JSON.stringify(jsonData),
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    },
                    credentials: 'include',
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        setSessionMessage('Folder updated', 'success');
                        location.reload();
                    } else {
                        setSessionMessage('Error updating folder: ' + data.errors.join(', '), 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    setSessionMessage('Failed to update folder due to a network error.', 'error');
                });
            });
        });
    });
</script>


<script>
    $(document).ready(function() {
        $('.dropdown').on('show.bs.dropdown', function(e) {
            var $dropdownMenu = $(this).find('.dropdown-menu');
            var $dropdownToggle = $(this).find('.dropdown-toggle');
            
            // Temporarily detach the menu to move it to the body
            $('body').append($dropdownMenu.detach());
            
            // Get positioning details
            var toggleOffset = $dropdownToggle.offset();
            var toggleHeight = $dropdownToggle.outerHeight();
            var menuWidth = $dropdownMenu.outerWidth();
            var toggleWidth = $dropdownToggle.outerWidth();
            
            // Adjust dropdown's positioning to open to the left
            $dropdownMenu.css({
                'display': 'block',
                'top': toggleOffset.top + toggleHeight + "px", // Position below the toggle button
                'left': toggleOffset.left - menuWidth + "px", // Adjust to open to the left
                'position': 'absolute'
            });
            
            // Prevent scrolling to the bottom
            $dropdownMenu.addClass('position-fixed');
        }).on('hide.bs.dropdown', function(e) {
            var $dropdownMenu = $(this).find('.dropdown-menu');
            
            // Move the menu back to its original parent
            $(this).append($dropdownMenu.detach());
            $dropdownMenu.css({
                'display': '',
                'position': '',
                'top': '',
                'left': ''
            });
            
        });
    });
</script>
{% endblock %}

{% endblock %}