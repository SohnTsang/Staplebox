{% extends "base_users.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% load crispy_forms_filters %}

{% block title %}Product Directory{% endblock %}


{% block extra_css %}

<style>



a {
    cursor: pointer;
}

.dropdown-menu {
    border-radius: 5px;
    font-size: 14px;
    min-width: 200px;
    max-width: 200px;
}

.dropdown-menu li {
    padding-top: 0.1rem;
    padding-bottom: 0.1rem;
}

.btn-modern {
    background-color: #295893; /* Primary color */
    border: none;
    color: white;
    padding: 8px 15px;
    text-align: center;
    text-decoration: none;
    font-size: 14px;
    border-radius: 5px; /* Rounded corners */
}

.btn-modern:hover {
    background-color: #2f82c0 !important; /* Darker shade for hover/focus */
    color: white;
    text-decoration: none; /* Prevents underlining text */
}
.btn-modern:active, .btn-modern:focus-visible {
    background-color: #1e4f7f !important; /* Darker shade for active state */
    color: white;
    text-decoration: none; /* Prevents underlining text */
}


.table > :not(caption) > * > * {
  padding: 0.5rem 0.5rem;
  color: var(--bs-table-color-state, var(--bs-table-color-type, var(--bs-table-color)));
  background-color: var(--bs-table-bg);
  border-bottom-width: var(--bs-border-width);
  box-shadow: inset 0 0 0 9999px var(--bs-table-bg-state, var(--bs-table-bg-type, var(--bs-table-accent-bg)));
}

@media (min-width: 1055px) {
    #detail {
        max-width: 23%;
    }
    #left-explorer {
        max-width: 80%;
    }
}


@media (max-width: 1054px) {
    #detail {
        display: none !important;
    }
    #left-explorer{
        width: 100% !important;
    }
}

.text-muted-weight {
    font-weight: 400;
    color:#181818;
    font-size: small;
}

#right-panel-title {
    display: flex;
    align-items: center; /* Align items vertically in the center */
    
}

.name-container {
    margin-left: 8px; /* Adjust based on your icon's width or desired spacing */
    flex: 1; /* Allows the text container to take up the remaining space */
    white-space: normal; /* Ensure text wraps */
    word-wrap: break-word; /* Break the word to prevent overflow */
    overflow-wrap: break-word; /* Standard property for breaking long words to prevent overflow */
    hyphens: auto; /* Allow hyphenation of words in supported browsers */
}



.title {
    min-height: 70px;
    align-items: center; /* This vertically centers the content */
    display: flex;
    flex-shrink: 0; /* Prevents these elements from shrinking, ensuring they maintain their size */

}


.table-responsive {
    overflow-y: auto;
    display: block;
}

#information {
    position: relative;  /* This makes it the positioning context for the overlay */
    overflow-y: auto;
    display: block;
    min-height: 300px;  /* Ensure it has a minimum height for better UX */
}

/* Sticky table header */
.table thead th {
    position: sticky;
    top: 0;
    background-color: #fff; /* Match the background to your table/theme */
    z-index: 1; /* Ensures the header is above other content */
}

/* Ensure the table stretches to full width */
.table {
    width: 100%;
    margin-bottom: 0rem; /* Adjust as necessary */
}

.truncate-name {
    max-width: 300px !important; /* Adjust based on your layout */
    width: 300px !important; /* Adjust based on your layout */
    min-width: 200px !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
}

.truncate-name a {
    vertical-align: middle;
}

.truncate-original-name {
    max-width: 250px !important; /* Adjust based on your layout */
    width: 200px !important; /* Adjust based on your layout */
    min-width: 150px !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
}

.truncate-type {
    max-width: 250px !important; /* Adjust based on your layout */
    width: 250px !important; /* Adjust based on your layout */
    min-width: 100px !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
}

.truncate-version {
    max-width: 100px !important; /* Adjust based on your layout */
    width: 100px !important; /* Adjust based on your layout */
    min-width: 50px !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
}

.truncate-modified {
    max-width: 250px !important; /* Adjust based on your layout */
    width: 250px !important; /* Adjust based on your layout */
    min-width: 150px !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
}

.fixed-width-header {
    max-width: 50px !important; /* Adjust the width as needed */
    width: 50px !important; /* Adjust the width as needed */
    min-width: 50px !important;
}

.clickable-row td {
    text-decoration: none;
}

/* Optional: Remove text decoration on hover if desired */
.clickable-row td:hover {
    text-decoration: none;
}

.breadcrumb-navigation:hover {
    background-color: #3d9dd433;
}

.breadcrumb-item {
  + .breadcrumb-item::before {
    content: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' fill='none' viewBox='0 0 20 20'%3E%3Cpath d='M10 17L15 12' stroke='%23454545' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M15 12L10 7' stroke='%23454545' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E") !important;
    color: #7d8daa;
  }
}

.checkbox-column {
    width: 40px !important; /* Adjust based on your design needs */
    max-width: 40px !important;
    min-width: 40px !important;
}

.highlighted-row {
    background-color: #4f96ee33 !important; /* Or any color you prefer */
}

.detail-item {
    margin-bottom: 0.6rem;
    padding-bottom: 0.5rem;
    padding-left: 1rem;
    padding-right: 1rem;
}

.detail-item:last-child {
    border-bottom: none;
    padding-bottom: 1rem;
}

.detail-item:first-child {
    padding-top: 1rem;
}

.detail-item strong, .access-item strong{
    font-size: 0.8rem;
    display: block;
    color: rgb(44, 44, 44);
    margin-bottom: .2rem;
    font-weight: 600;
}

.detail-item p {
    margin: 0;
    padding: 0;
    color: #474747;
    font-size: 0.9rem;
}

.vh-92 {
    height: 92vh;
}

</style>
{% endblock extra_css %}

{% block content %}


<div id="product-explorer" data-product-id="{{ product.id }}" data-root-folder-id="{{ root_folder_id }}" class="container-fluid mt-1" data-product-id="{{ product.id }}">
    <div class="row">
        <div id="left-explorer" class="col-md-12 col-lg-9 pe-lg-2">
            <div class="bg-white rounded-2 wrapper vh-92">
                <div class="title">
                    <h4 class="text-primary-custom fw-bold px-4">{{ product.product_name }}</h4>
                </div>
                

                <div id="folders-container" class="ms-3 mt-2">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            {% for breadcrumb in breadcrumbs %}
                                <li class="breadcrumb-item">
                                    {% if forloop.last %}
                                        <span class="p-2 h6 fw-bold">{{ breadcrumb.name }}</span>
                                    {% else %}
                                        <a href="{% url 'products:product_explorer_folder' product_id=product.id folder_id=breadcrumb.id %}" class="text-primary-custom opacity-75 breadcrumb-navigation p-2 h6">{{ breadcrumb.name }}</a>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ol>
                    </nav>
                </div>
                
                <div class="d-flex justify-content-start align-items-center pb-3 px-4">
                    <noscript>
                        <form id="create-folder-form" method="post" action="{% url 'products:folder_create' product_id=product.id %}" class="">
                            {% csrf_token %}
                            <div class="row g-2 align-items-center">
                                <div class="col-auto">
                                    <input type="text" class="form-control" placeholder="New Folder Name" id="folderName" name="name" required>
                                    <button class="btn btn-modern" type="submit">Create Folder</button>
                                </div>
                                {% if current_folder %}
                                    <input type="hidden" id="parentFolderId" name="parent_id" value="{{ current_folder.id }}">
                                {% else %}
                                    <input type="hidden" id="parentFolderId" name="parent_id" value="{{ root_folder.id }}">
                                {% endif %}
                            </div>
                        </form>
                    </noscript>
                    <!-- Spacer div to push the next element(s) to the right -->
                    <div class="gap-3 d-flex">
                        <button type="button" class="btn align-items-center justify-content-center img-wrapper" data-bs-toggle="modal" data-bs-target="#createFolderModal" style="background: none; border: none; padding: 0;">
                            <img src="{% static 'images/navbar_icon/new_folder.png' %}" alt="Create Folder" style="height: 24px; width: 24px;">
                        </button>                    
                        <button type="button" class="btn btn-modern ms-2" data-bs-toggle="modal" data-bs-target="#uploadDocumentModal">Upload File</button>
                    </div>
                    <div class="ms-auto"></div>
                    
                    <!-- This link/button will be aligned to the right -->
                    <a href="{% url 'access_control:manage_access' product_id=product.id %}" class="btn btn-modern text-white">Manage Access</a>
                </div>

                


                <div class="table-responsive px-4">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr class="">
                                <th scope="col" class="small truncate-name">Name</th>
                                <th scope="col" class="small truncate-original-name">Original Name</th>
                                <th scope="col" class="small truncate-type">Category</th>
                                <th scope="col" class="small truncate-modified">Date Modified</th>
                                <th scope="col" class="small truncate-version">Version</th>
                                <th scope="col" class="fixed-width-header"></th>
                            </tr>
                        </thead>
                        
                        <tbody>
                            <!-- Folders -->
                            {% for folder in subfolders %}
                            <!--<tr class="clickable-row" onclick="window.location='{% url 'products:product_explorer_folder' product_id=product.id folder_id=folder.id %}';">-->
                                <tr class="clickable-row" draggable="true" data-id="{{ folder.id }}" data-owner="{{ folder.created_by }}" data-name="{{ folder.name }}" data-modified="{{ folder.updated_at|date:"Y-m-d H:i" }}" data-created="{{ folder.created_at|date:"Y-m-d H:i" }}" data-type="folder">
                                    <td class="small truncate-name">
                                        <svg class="me-2" width="23" height="20" viewBox="0 0 17 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M16 6.32099V12.642C16 13.4751 15.3473 14.1576 14.5194 14.2179L14.4 14.2222H1.6C0.75651 14.2222 0.0654679 13.5776 0.00438862 12.7599L0 12.642L0 6.32099L16 6.32099ZM6.0155 0C6.45292 0 6.86907 0.176755 7.16925 0.485378L7.26488 0.593075L8.38448 1.97531L14.4 1.97531C15.2435 1.97531 15.9345 2.61995 15.9956 3.43762L16 3.55556V4.74074L0 4.74074L0 1.58025C0 0.747171 0.652702 0.0646597 1.48059 0.00433444L1.6 0L6.0155 0Z" fill="#CCA92D"/>
                                        </svg>
                                        <a href="{% url 'products:product_explorer_folder' product_id=product.id folder_id=folder.id %}">
                                            <span class="fw-less-bold">{{ folder.name }}</span>
                                        </a>
                                    </td>
                                    <td class="text-muted-weight small truncate-original-name"> — </td>
                                    <td class="text-muted-weight small truncate-type"> — </td>
                                    <td class="text-muted-weight small truncate-modified">{{ folder.updated_at|date:"Y-m-d H:i" }}</td>
                                    <td class="text-muted-weight small truncate-version ps-4"> — </td>
                                    <td class="text-center">
                                        <div class="dropdown">
                                            <button class="btn btn-secondary dropdown-toggle px-0 py-1" type="button" id="actionDropdown{{ forloop.counter }}" data-bs-toggle="dropdown" aria-expanded="false">
                                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <g clip-path="url(#clip0_1417_12)">
                                                        <rect x="12" y="12" width="0.01" height="0.01" stroke="#292929" stroke-width="3" stroke-linejoin="round"/>
                                                        <rect x="12" y="5" width="0.01" height="0.01" stroke="#292929" stroke-width="3" stroke-linejoin="round"/>
                                                        <rect x="12" y="19" width="0.01" height="0.01" stroke="#292929" stroke-width="3" stroke-linejoin="round"/>
                                                    </g>
                                                    <defs>
                                                        <clipPath id="clip0_1417_12">
                                                            <rect width="40" height="40" fill="white" transform="translate(0 0.000915527)"/>
                                                        </clipPath>
                                                    </defs>
                                                </svg>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="actionDropdown{{ forloop.counter }}">
                                                <!-- Access Action -->
                                                <li>
                                                    <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#accessControlModal" data-folder-id="{{ folder.id }}" data-product-id="{{ product.id }}">
                                                        <i class="fas fa-user"></i> &nbsp; Access Control
                                                    </a>
                                                </li>

                                                <li>
                                                    <a class="dropdown-item edit-folder" href="#" data-bs-toggle="modal" data-bs-target="#editFolderModal" data-folder-id="{{ folder.id }}" data-product-id="{{ product.id }}">
                                                        <i class="fas fa-edit"></i> &nbsp; Edit
                                                    </a>
                                                </li>

                                                <!-- Update Action -->
                                                <li>
                                                    <a href="#" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#moveEntityModal"
                                                       data-entity-type="folder" data-entity-id="{{ folder.id }}" data-product-id="{{ product.id }}" data-moving-folder-id="{{ folder.id }}"
                                                       data-current-folder-id="{{ folder.parent.id }}" data-url="{% url 'products:move_entity' product_id=product.id entity_type='folder' entity_id=folder.id current_folder_id=folder.parent.id %}">
                                                        <i class="fas fa-user"></i> &nbsp; Move Folder
                                                    </a>
                                                </li>

                                                <li><hr class="dropdown-divider"></li>
                                                <!-- Delete Action -->
                                                <li>
                                                    <form action="{% url 'folder:delete_folder' folder_id=folder.id %}" method="post" onsubmit="return confirm('Are you sure you want to delete this folder?');">
                                                        {% csrf_token %}
                                                        <button type="submit" class="dropdown-item text-danger"">
                                                            <i class="fas fa-trash"></i> &nbsp; Delete
                                                        </button>
                                                    </form>
                                                </li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                            
                            <!-- Documents -->
                            {% for document in documents %}
                            <tr class="clickable-row" draggable="true" data-id="{{ document.id }}" data-owner="{{ document.uploaded_by }}" data-version="{{ document.version }}" data-filetype="{{ document.file_type }}" data-name="{{ document.display_filename }}" data-modified="{{ document.updated_at|date:"Y-m-d H:i" }}" data-original="{{ document.original_filename }}" data-category="{{ document.document_type.type_name }}" data-created-by="{{ document.latest_uploaded_by }}" data-created="{{ document.created_at|date:"Y-m-d H:i" }}" data-latest-comment="{{ document.latest_comment }}" data-filesize="{{ document.latest_file_size }}" data-type="document">
                                <td class="small truncate-name">
                                    <a href="{% url 'documents:download_document' document.id %}" data-document-id="{{ document.id }}">
                                        {% with document.file_type|upper as doc_type %}
                                            {% if doc_type == '.PDF' %}
                                                <svg class="me-2" width="23" height="22" viewBox="0 0 15 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M6.8 0V5.525C6.8 6.18774 7.30568 6.73238 7.95221 6.79416L8.075 6.8H13.6V15.3C13.6 16.1962 12.9065 16.9304 12.0269 16.9953L11.9 17H1.7C0.803792 17 0.0695594 16.3065 0.0046627 15.4269L0 15.3L0 1.7C0 0.803792 0.693496 0.0695596 1.57313 0.00466291L1.7 0L6.8 0ZM8.5 0.036856C8.77387 0.094843 9.03044 0.219882 9.24584 0.402096L9.35 0.497921L13.1021 4.25C13.3031 4.451 13.4486 4.69715 13.5286 4.96461L13.5631 5.1H8.5V0.036856Z" fill="#295893"/>
                                                </svg>  
                                            {% elif doc_type == '.WORD' %}
                                                <img src="{% static 'icons/word-icon.png' %}" alt="Word" width="16" height="16" class="me-2">
                                            {% elif doc_type == '.PNG' %}
                                                <svg class="me-2" width="23" height="20" viewBox="0 0 17 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M14.4 0C15.2837 0 16 0.696446 16 1.55556V12.4444C16 13.3036 15.2837 14 14.4 14H1.6C0.716344 14 0 13.3036 0 12.4444L0 1.55556C0 0.696446 0.716344 0 1.6 0L14.4 0ZM14.4 1.55556L1.6 1.55556L1.6 9.4115L5.59584 5.52666C5.98637 5.147 6.61952 5.147 7.01008 5.52666L10.2627 8.68902L11.2527 7.7266C11.6432 7.34689 12.2764 7.34689 12.6669 7.7266L14.4 9.4115V1.55556ZM10.8 3.11111C11.4627 3.11111 12 3.63344 12 4.27778C12 4.92211 11.4627 5.44444 10.8 5.44444C10.1373 5.44444 9.6 4.92211 9.6 4.27778C9.6 3.63344 10.1373 3.11111 10.8 3.11111Z" fill="#AC3140"/>
                                                </svg>
                                            {% elif doc_type == '.JPG' %}
                                                <svg class="me-2" width="23" height="20" viewBox="0 0 17 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M14.4 0C15.2837 0 16 0.696446 16 1.55556V12.4444C16 13.3036 15.2837 14 14.4 14H1.6C0.716344 14 0 13.3036 0 12.4444L0 1.55556C0 0.696446 0.716344 0 1.6 0L14.4 0ZM14.4 1.55556L1.6 1.55556L1.6 9.4115L5.59584 5.52666C5.98637 5.147 6.61952 5.147 7.01008 5.52666L10.2627 8.68902L11.2527 7.7266C11.6432 7.34689 12.2764 7.34689 12.6669 7.7266L14.4 9.4115V1.55556ZM10.8 3.11111C11.4627 3.11111 12 3.63344 12 4.27778C12 4.92211 11.4627 5.44444 10.8 5.44444C10.1373 5.44444 9.6 4.92211 9.6 4.27778C9.6 3.63344 10.1373 3.11111 10.8 3.11111Z" fill="#AC3140"/>
                                                </svg>
                                            {% elif doc_type == '.SVG' %}
                                                <svg class="me-2" width="23" height="20" viewBox="0 0 17 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M14.4 0C15.2837 0 16 0.696446 16 1.55556V12.4444C16 13.3036 15.2837 14 14.4 14H1.6C0.716344 14 0 13.3036 0 12.4444L0 1.55556C0 0.696446 0.716344 0 1.6 0L14.4 0ZM14.4 1.55556L1.6 1.55556L1.6 9.4115L5.59584 5.52666C5.98637 5.147 6.61952 5.147 7.01008 5.52666L10.2627 8.68902L11.2527 7.7266C11.6432 7.34689 12.2764 7.34689 12.6669 7.7266L14.4 9.4115V1.55556ZM10.8 3.11111C11.4627 3.11111 12 3.63344 12 4.27778C12 4.92211 11.4627 5.44444 10.8 5.44444C10.1373 5.44444 9.6 4.92211 9.6 4.27778C9.6 3.63344 10.1373 3.11111 10.8 3.11111Z" fill="#AC3140"/>
                                                </svg>
                                            {% else %}
                                                <!-- Optionally, show a default icon for unspecified document types -->
                                                <svg class="me-2" width="23" height="22" viewBox="0 0 15 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M6.8 0V5.525C6.8 6.18774 7.30568 6.73238 7.95221 6.79416L8.075 6.8H13.6V15.3C13.6 16.1962 12.9065 16.9304 12.0269 16.9953L11.9 17H1.7C0.803792 17 0.0695594 16.3065 0.0046627 15.4269L0 15.3L0 1.7C0 0.803792 0.693496 0.0695596 1.57313 0.00466291L1.7 0L6.8 0ZM8.5 0.036856C8.77387 0.094843 9.03044 0.219882 9.24584 0.402096L9.35 0.497921L13.1021 4.25C13.3031 4.451 13.4486 4.69715 13.5286 4.96461L13.5631 5.1H8.5V0.036856Z" fill="#295893"/>
                                                </svg>                                            
                                            {% endif %}
                                        {% endwith %}
                                        <span class="fw-less-bold">{{ document.display_filename }}</span>

                                    </a>
                                </td>
                                <td class="text-muted-weight small truncate-original-name">{{ document.original_filename }}</td>
                                <td class="text-muted-weight small truncate-type">{{ document.document_type.type_name }}</td>
                                <td class="text-muted-weight small truncate-modified">{{ document.updated_at|date:"Y-m-d H:i" }}</td>
                                <td class="text-muted-weight small truncate-version ps-4">{{ document.version }}</td>
                                <td class="text-center">
                                    <div class="dropdown">
                                        <button class="btn btn-secondary dropdown-toggle px-0 py-1" type="button" id="actionDropdown{{ forloop.counter }}" data-bs-toggle="dropdown" aria-expanded="false">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <g clip-path="url(#clip0_1417_12)">
                                                    <rect x="12" y="12" width="0.01" height="0.01" stroke="#292929" stroke-width="3" stroke-linejoin="round"/>
                                                    <rect x="12" y="5" width="0.01" height="0.01" stroke="#292929" stroke-width="3" stroke-linejoin="round"/>
                                                    <rect x="12" y="19" width="0.01" height="0.01" stroke="#292929" stroke-width="3" stroke-linejoin="round"/>
                                                </g>
                                                <defs>
                                                    <clipPath id="clip0_1417_12">
                                                        <rect width="40" height="40" fill="white" transform="translate(0 0.000915527)"/>
                                                    </clipPath>
                                                </defs>
                                            </svg>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="actionDropdown{{ forloop.counter }}">
                                            <!-- Access Action -->
                                            <li>
                                                <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#accessControlModal" data-document-id="{{ document.id }}" data-product-id="{{ product.id }}">
                                                    <i class="fas fa-user"></i> &nbsp; Access Control
                                                </a>
                                            </li>

                                            <li>
                                                <a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#editDocumentModal" data-document-id="{{ document.id }}">
                                                    <i class="fas fa-user"></i> &nbsp; Edit
                                                </a>
                                            </li>

                                            <li>
                                                <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#commentModal" data-document-id="{{ document.id }}">
                                                    <i class="fas fa-user"></i> &nbsp; Comment
                                                </a>
                                            </li>
                                            
                                            <li>
                                                <a href="#" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#moveEntityModal"
                                                   data-entity-type="document" data-entity-id="{{ document.id }}" data-product-id="{{ product.id }}"
                                                   data-current-folder-id="{{ document.folder.id }}" data-url="{% url 'products:move_entity' product_id=product.id entity_type='document' entity_id=document.id current_folder_id=document.folder.id %}">
                                                    <i class="fas fa-user"></i> &nbsp; Move Document
                                                </a>
                                            </li>

                                            <li>
                                                <a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#updateDocumentModal" data-document-id="{{ document.id }}">
                                                    <i class="fas fa-edit"></i> &nbsp; Upload New Version
                                                </a>
                                            </li>

                                            <li>
                                                <a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#documentVersionsModal" data-document-id="{{ document.id }}">
                                                    <i class="fas fa-history"></i> &nbsp; Version History
                                                </a>
                                            </li>

                                            <!-- Update Action -->
                                            
                                            <li><hr class="dropdown-divider"></li>
                                            <!-- Delete Action -->
                                            <li>
                                                <form action="{% url 'documents:delete_document' document_id=document.id %}" method="post" onsubmit="return confirm('Are you sure you want to delete this folder?');">
                                                    {% csrf_token %}
                                                    <button type="submit" class="dropdown-item text-danger"">
                                                        <i class="fas fa-trash"></i> &nbsp; Delete
                                                    </button>
                                                </form>
                                            </li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="detail" class="col-lg-3 ps-2">
            <div class="bg-white rounded-2 wrapper vh-92">
                <div class="title">
                    <h6 id="right-panel-title" class="text-primary-custom mb-0 px-3 fw-bold">{{ product.product_name }}</h6>
                </div>
				<div class="">
					<ul class="nav nav-tabs modern-tabs col-12" id="invitationTab" role="tablist">
						
						<li class="nav-item col-6" role="presentation">
							<button class="nav-link active tab-link py-2-custom" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab" aria-controls="sent" aria-selected="false">
								<div class="button-text small">Details</div>
							</button>
						</li>
                        <li class="nav-item col-6" role="presentation">
							<button class="nav-link  tab-link py-2-custom" id="access-tab" data-bs-toggle="tab" data-bs-target="#access" type="button" role="tab" aria-controls="received" aria-selected="true">
								<div class="button-text small">Access</div>
							</button>
						</li>
					</ul>
				</div>
				<div class="tab-content" id="information">
                    <div id="loadingSpinner" class="loading-spinner-overlay" style="display: none;">
                        <div class="loader"></div>
                    </div>
					<div class="tab-pane fade show active" id="details" role="tabpanel" aria-labelledby="details-tab">
						<div class="list-group" id="details-information">
							<img src="{% static 'images/empty_state/show_info2.png' %}" alt="No Items Selected" class="mt-5 text-center" style="align-self:center;" width="210" height="180">
                            <small class="text-center mt-3">Select an item to show information</small>
						</div>
					</div>
                    <div class="tab-pane fade" id="access" role="tabpanel" aria-labelledby="access-tab">
						<div class="list-group" id="access-information">
							<img src="{% static 'images/empty_state/no_partners.png' %}" alt="No Items Selected" class="mt-5 text-center" style="align-self:center;" width="210" height="180">
                            <small class="text-center mt-3">Select an item to show information</small>
                        </div>
					</div>
				</div>
			</div>
		</div>
    </div>
</div>

<!-- Create Folder Modal -->
<!--{% include "modal/create_folder_modal.html" %}-->
{% include "modal/upload_document_modal.html" %}
{% include "modal/create_folder_modal.html" %}
{% include "modal/edit_folder_modal.html" %}
{% include "modal/remove_access_confirm_modal.html" %}
{% include "modal/edit_document_modal.html" %}
{% include "modal/document_version_modal.html" %}
{% include "modal/update_document_modal.html" %}
{% include "modal/comment_modal.html" %}
{% include "modal/move_entity_modal.html" %}
{% include "modal/access_control_modal.html" %}


{% block javascript %}

<!--<script src="{% static 'products/js/product_explorer.js' %}"></script>-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script>
    const productId = '{{ product.id }}'; // Make sure this is rendered server-side or appropriately defined somewhere accessible
</script>

<!-- Access Control Moda -->
<script>
    document.querySelectorAll('[data-bs-toggle="modal"][data-bs-target="#accessControlModal"]').forEach(element => {
        element.addEventListener('click', function() {

            const modal = document.getElementById('accessControlModal');
            const productId = this.getAttribute('data-product-id');
            const folderId = this.getAttribute('data-folder-id');
            const documentId = this.getAttribute('data-document-id');
            const itemType = folderId ? 'folder' : 'document';
            const itemId = folderId || documentId;

            // Update the form hidden inputs for item_id and item_type
            modal.querySelector('#item_id').value = itemId;
            modal.querySelector('#item_type').value = itemType;

            let url = `/access_control/get_partners_with_access_json/${itemId}/${itemType}/`;
            
            fetch(url)
            .then(response => response.json())
            .then(data => {
                const partnerContainer = modal.querySelector('#granted-partner-information');
                partnerContainer.innerHTML = '';  // Clear previous entries

                // Check if 'data' is an array as expected
                if (Array.isArray(data) && data.length === 0) {
                    partnerContainer.innerHTML = '<small class="mt-3">No access granted to any partners</small>';
                } else if (Array.isArray(data)) {
                    data.forEach(partner => {
                        const div = document.createElement('div');
                        div.className = 'list-group-item flex-column';
                        div.innerHTML = `
                            <div class="d-flex py-1">
                                <div class="flex-grow-1 d-flex flex-column ms-3">
                                    <div class="fw-less-bold">${partner.company_name}</div>
                                    <div class="text-primary-custom fw-medium small">${partner.company_role}</div>
                                </div>
                                <button type="button" class="btn btn-danger btn-sm remove-access" onclick="removeAccess(this.getAttribute('data-partner-id'), '${itemType}', ${itemId}, ${productId})" data-partner-id="${partner.partner2_id}" style="align-self:center;">Remove</button>
                            </div>
                        `;
                        partnerContainer.appendChild(div);
                    });
                } else {
                    console.error('Unexpected data format:', data);
                }
            })
            .catch(error => console.error('Error loading partner data:', error));
        });
    });

</script>


<!-- drag and drop to move folder -->
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const rows = document.querySelectorAll('.clickable-row');
        let lastSelectedRow = null;
        const initialProductName = document.querySelector('#right-panel-title').textContent;
        const productNameElement = document.querySelector('#right-panel-title');

        rows.forEach(row => {
            row.addEventListener('click', function(e) {
                if (e.shiftKey && lastSelectedRow) {
                    const startRow = Array.from(rows).indexOf(lastSelectedRow);
                    const endRow = Array.from(rows).indexOf(this);
                    const [startIndex, endIndex] = [Math.min(startRow, endRow), Math.max(startRow, endRow)];
                    for (let i = startIndex; i <= endIndex; i++) {
                        rows[i].classList.add('highlighted-row');
                    }
                } else if (e.ctrlKey) {
                    this.classList.toggle('highlighted-row');
                } else {
                    if (!this.classList.contains('highlighted-row')) {
                        rows.forEach(r => r.classList.remove('highlighted-row'));
                        this.classList.add('highlighted-row');
                        updatePanelsBasedOnSelection(this); // Update panels when a new row is selected
                    } else {
                        rows.forEach(r => r.classList.remove('highlighted-row'));
                        resetPanelsToDefault(initialProductName); // Reset panels when deselecting
                    }
                }
                lastSelectedRow = this; // This row now becomes the last selected row
            });

            row.addEventListener('dblclick', function() {
                if (this.dataset.type === 'folder') {
                    const folderId = this.dataset.id; // Assuming `data-id` holds the folder ID
                    window.location.href = `/products/${productId}/explorer/${folderId}/`; // Adjust URL as needed
                }
            });

            row.addEventListener('dragstart', function(e) {
                if (!this.classList.contains('highlighted-row')) {
                    this.classList.add('highlighted-row');
                }
                const selectedItems = document.querySelectorAll('.highlighted-row');
                const ids = Array.from(selectedItems).map(row => row.dataset.id);
                const types = Array.from(selectedItems).map(row => row.dataset.type);

                const dragData = ids.join(',') + '|' + types.join(',');
                e.dataTransfer.setData('text/plain', dragData);
            });

            row.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });

            row.addEventListener('drop', function(e) {
                e.preventDefault();
                const dropData = e.dataTransfer.getData('text/plain').split('|');
                const ids = dropData[0].split(',');
                const entityTypes = dropData[1] ? dropData[1].split(',') : [];

                if (ids.length === 1 && ids[0] === '') {
                    return;
                }

                const targetId = this.dataset.id;
                const targetType = this.dataset.type;

                if (targetType === 'document') {
                    return; // Do nothing when the target is a document
                }

                if (ids.includes(targetId)) return; // Avoid moving into itself

                moveEntities(ids, entityTypes, targetId);
            });
        });

        function moveEntities(ids, entityTypes, targetId) {
            showLoading();
            const formData = new FormData();
            ids.forEach((id, index) => {
                formData.append('entity_ids[]', id);
                formData.append('entity_types[]', entityTypes[index]); // Ensure each ID has a corresponding type appended
            });
            formData.append('target_folder_id', targetId);

            fetch(`/products/${productId}/move_entities/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken') // CSRF token handling
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Move successful:', data.message);
                    window.location.reload();
                } else {
                    console.error('Move failed:', data.message);
                    alert('Failed to move items: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error moving items:', error);
                alert('An error occurred while moving items.');
            })
            .finally(() => {
                hideLoading();
            });
        }

        document.addEventListener('click', function(e) {
            const modal = document.getElementById('confirmationModal');
            const isModalOpen = modal && modal.style.display === 'block';
            
            if (!e.target.closest('.clickable-row') && !e.target.closest('#detail') && !isModalOpen) {
                rows.forEach(row => row.classList.remove('highlighted-row'));
                resetPanelsToDefault(initialProductName);
            }
        });

        function updateLeftPanel(partners, itemType, itemId) {
            const panel = document.getElementById('access-information');
            let html = partners.length > 0 ? '' : '<div class="detail-item"><strong>No Partners Granted Access</strong></div>';
            partners.forEach(partner => {
                html += `<div class="list-group-item list-group-item-action partner-access-item" data-partner-id="${partner.partner2_id}" tabindex="0">
                    <div class="d-flex py-1">
                        <div class="visually-hidden" style="align-self: center;"><input type="radio" name="partners" value="${partner.partner2_id}" id="partner_${partner.partner2_id}"></div>
                        <div class="flex-grow-1 d-flex flex-column ms-3">
                            <div class="fw-less-bold">${partner.company_name}</div>
                            <div class="text-primary-custom fw-medium small">${partner.company_role}</div>
                            <!--<div class="small">${partner.access_detail}</div>-->
                        </div>
                    </div>
                </div>`;
            });
            panel.innerHTML = html;
        }

        function updateRightPanel(data) {
            const { owner, type, version, fileType, name, original, modified, category, createdBy, created, filesize, latestComment } = data;
            if (type === "document") {
                document.getElementById("details-information").innerHTML = `
                    <div class="detail-item"><strong>Original Name</strong><small>${original}</small></div>
                    <div class="detail-item"><strong>Category</strong><small>${category}</small></div>
                    <div class="detail-item"><strong>Latest Comment</strong><small>${latestComment}</small></div>
                    <div class="detail-item"><strong>Owner</strong><small>${owner}</small></div>
                    <div class="detail-item"><strong>File Size</strong><small>${filesize}</small></div>
                    <div class="detail-item"><strong>Version</strong><small>${version}</small></div>
                    <div class="detail-item"><strong>Modified</strong><small>${modified} by ${createdBy}</small></div>
                    <div class="detail-item"><strong>Created</strong><small>${created}</small></div>
                    `;
                    // Switch to the details tab
                    // new bootstrap.Tab(document.querySelector('#details-tab')).show();
            }
            else if (type === "folder") {
                document.getElementById("details-information").innerHTML = `
                    <div class="detail-item"><strong>Owner</strong><small>${owner}</small></div>
                    <div class="detail-item"><strong>Modified</strong><small>${modified}</small></div>
                    <div class="detail-item"><strong>Created</strong><small>${created}</small></div>
                    `;
                    // Switch to the details tab
                    // new bootstrap.Tab(document.querySelector('#details-tab')).show();
            }
        }

        function getIconHTML(fileType) {
            // Define your icons here
            const icons = {
                '.PDF': '<svg class="" width="20" height="23" viewBox="0 0 15 18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6.8 0V5.525C6.8 6.18774 7.30568 6.73238 7.95221 6.79416L8.075 6.8H13.6V15.3C13.6 16.1962 12.9065 16.9304 12.0269 16.9953L11.9 17H1.7C0.803792 17 0.0695594 16.3065 0.0046627 15.4269L0 15.3L0 1.7C0 0.803792 0.693496 0.0695596 1.57313 0.00466291L1.7 0L6.8 0ZM8.5 0.036856C8.77387 0.094843 9.03044 0.219882 9.24584 0.402096L9.35 0.497921L13.1021 4.25C13.3031 4.451 13.4486 4.69715 13.5286 4.96461L13.5631 5.1H8.5V0.036856Z" fill="#295893"/></svg>',
                '.WORD': '<img src="{% static "icons/word-icon.png" %}" alt="Word" width="16" height="16" class="">',
                '.PNG': '<svg class="" width="23" height="19" viewBox="0 0 17 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14.4 0C15.2837 0 16 0.696446 16 1.55556V12.4444C16 13.3036 15.2837 14 14.4 14H1.6C0.716344 14 0 13.3036 0 12.4444L0 1.55556C0 0.696446 0.716344 0 1.6 0L14.4 0ZM14.4 1.55556L1.6 1.55556L1.6 9.4115L5.59584 5.52666C5.98637 5.147 6.61952 5.147 7.01008 5.52666L10.2627 8.68902L11.2527 7.7266C11.6432 7.34689 12.2764 7.34689 12.6669 7.7266L14.4 9.4115V1.55556ZM10.8 3.11111C11.4627 3.11111 12 3.63344 12 4.27778C12 4.92211 11.4627 5.44444 10.8 5.44444C10.1373 5.44444 9.6 4.92211 9.6 4.27778C9.6 3.63344 10.1373 3.11111 10.8 3.11111Z" fill="#AC3140"/></svg>',
                '.JPG': '<svg class="" width="23" height="19" viewBox="0 0 17 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14.4 0C15.2837 0 16 0.696446 16 1.55556V12.4444C16 13.3036 15.2837 14 14.4 14H1.6C0.716344 14 0 13.3036 0 12.4444L0 1.55556C0 0.696446 0.716344 0 1.6 0L14.4 0ZM14.4 1.55556L1.6 1.55556L1.6 9.4115L5.59584 5.52666C5.98637 5.147 6.61952 5.147 7.01008 5.52666L10.2627 8.68902L11.2527 7.7266C11.6432 7.34689 12.2764 7.34689 12.6669 7.7266L14.4 9.4115V1.55556ZM10.8 3.11111C11.4627 3.11111 12 3.63344 12 4.27778C12 4.92211 11.4627 5.44444 10.8 5.44444C10.1373 5.44444 9.6 4.92211 9.6 4.27778C9.6 3.63344 10.1373 3.11111 10.8 3.11111Z" fill="#AC3140"/></svg>',
                '.SVG': '<svg class="" width="23" height="19" viewBox="0 0 17 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14.4 0C15.2837 0 16 0.696446 16 1.55556V12.4444C16 13.3036 15.2837 14 14.4 14H1.6C0.716344 14 0 13.3036 0 12.4444L0 1.55556C0 0.696446 0.716344 0 1.6 0L14.4 0ZM14.4 1.55556L1.6 1.55556L1.6 9.4115L5.59584 5.52666C5.98637 5.147 6.61952 5.147 7.01008 5.52666L10.2627 8.68902L11.2527 7.7266C11.6432 7.34689 12.2764 7.34689 12.6669 7.7266L14.4 9.4115V1.55556ZM10.8 3.11111C11.4627 3.11111 12 3.63344 12 4.27778C12 4.92211 11.4627 5.44444 10.8 5.44444C10.1373 5.44444 9.6 4.92211 9.6 4.27778C9.6 3.63344 10.1373 3.11111 10.8 3.11111Z" fill="#AC3140"/></svg>',
                // Add more as needed
                'DEFAULT': '<svg class="icon-folder" xmlns="http://www.w3.org/2000/svg" width="22" height="20" fill="currentColor" viewBox="0 0 18 16"><path d="M16 6.32099V12.642C16 13.4751 15.3473 14.1576 14.5194 14.2179L14.4 14.2222H1.6C0.75651 14.2222 0.0654679 13.5776 0.00438862 12.7599L0 12.642L0 6.32099L16 6.32099ZM6.0155 0C6.45292 0 6.86907 0.176755 7.16925 0.485378L7.26488 0.593075L8.38448 1.97531L14.4 1.97531C15.2435 1.97531 15.9345 2.61995 15.9956 3.43762L16 3.55556V4.74074L0 4.74074L0 1.58025C0 0.747171 0.652702 0.0646597 1.48059 0.00433444L1.6 0L6.0155 0Z" fill="#CCA92D"/></svg>' // Default icon
            };
            if (!fileType) {
                return icons['DEFAULT']; // Return default icon or an empty string if no icon should be shown
            }

            return icons[fileType.toUpperCase()] || icons['DEFAULT']; // Return matching icon or default
        }

        function fetchPartnersWithAccess(itemType, itemId) {
            const url = `/access_control/get_partners_with_access_json/${itemId}/${itemType}/`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    updateLeftPanel(data, itemType, itemId);
                    hideLoading(); // Hide loading after async operation is complete
                })
                .catch(error => {
                    console.error('Error loading partners:', error);
                    hideLoading(); // Ensure loading is hidden on error
                });
        }

        function updatePanelsBasedOnSelection(selectedRow) {
            const fileType = selectedRow.dataset.filetype;
            const iconHTML = getIconHTML(fileType);
            const name = selectedRow.dataset.name;
            const itemId = selectedRow.dataset.id;
            const itemType = selectedRow.dataset.type;

            productNameElement.innerHTML = `${iconHTML} <span class="name-container py-3">${name}</span>`;
            updateRightPanel(selectedRow.dataset);
            fetchPartnersWithAccess(itemType, itemId);
        }

        function resetPanelsToDefault(productName) {
            document.getElementById("details-information").innerHTML = `
                <img src="{% static 'images/empty_state/show_info2.png' %}" alt="Select an item to show information" class="mt-5 text-center" style="align-self:center;" width="210" height="180">
                <small class="text-center mt-3">Select an item to show information</small>
                `;
            document.getElementById("access-information").innerHTML = `
                <img src="{% static 'images/empty_state/no_partners.png' %}" alt="Select an item to show information" class="mt-5 text-center" style="align-self:center;" width="210" height="180">
                <small class="text-center mt-3">Select an item to show information</small>
                `;
            document.querySelectorAll('.clickable-row').forEach(r => r.classList.remove('highlighted-row'));
        }
    });


</script>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
            }
        }
    });
</script>

<!-- move entity modal -->
<script>
    var movingFolderId = null;

    document.addEventListener('DOMContentLoaded', function() {
        $('#moveEntityModal').on('show.bs.modal', function(event) {
            var button = $(event.relatedTarget);
            var modal = $(this);
            var entityType = button.data('entity-type');

            var movingFolderId = entityType === 'folder' ? button.data('moving-folder-id') : null;
            var url = button.data('url'); // Ensure this attribute is passed correctly
            
            $.ajax({
                url: url,
                success: function(response) {
                    modal.find('.modal-body').html(response.html);
                },
                error: function() {
                    modal.find('.modal-body').html('<p>Error loading information.</p>');
                }
            });
        });

        // Handling form submission within the modal
        $(document).on('submit', '.action-form', function(e) {
            e.preventDefault();
            var form = $(this);
            $.ajax({
                type: 'POST',
                url: form.attr('action'),
                data: form.serialize(),
                headers: {'X-CSRFToken': getCookie('csrftoken')},
                success: function(response) {
                    if (response.success) {
                        setSessionMessage(response.message, 'success');
                    } else {
                        setSessionMessage(response.error, 'error');  // Corrected from data.error to response.error
                    }
                },
                error: function() {
                    setSessionMessage('Failed to move due to a network error.', 'error');
                },
                complete: function() {
                    location.reload();
                      // Ensure message handling after the AJAX completes
                }
            });
            handleSessionMessage();
        });

        // Opening folders within the modal
        document.body.addEventListener('click', function(event) {
            const target = event.target;
            if (target.classList.contains('open-folder') || target.classList.contains('breadcrumb-link')) {
                const folderId = target.dataset.folderId;
                const local_productId = productId;
                if (!folderId || !local_productId) {
                    console.error('Folder ID or Product ID is missing!');
                    return;
                }

                const url = `/products/${local_productId}/explorer/folder/${folderId}/content/?moving_folder_id=${movingFolderId}`;
                fetch(url, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'  // This line is crucial
                    }
                })
                .then(response => response.json())
                .then(data => {
                    document.querySelector('.content-section').innerHTML = data.html;
                    updateBreadcrumbs(data.breadcrumbs);
                    document.querySelector('input[name="target_folder_id"]').value = folderId;
                })
                .catch(error => {
                    console.error('Error loading folder contents:', error);
                });
            }
        });

        function updateBreadcrumbs(breadcrumbs) {
            const breadcrumbContainer = document.querySelector('.breadcrumb-container ol');
            breadcrumbContainer.innerHTML = ''; // Clear existing breadcrumbs
            breadcrumbs.forEach((breadcrumb, index) => {
                const li = document.createElement('li');
                li.className = 'breadcrumb-item';
                if (index === breadcrumbs.length - 1) {
                    const span = document.createElement('span');
                    span.className = 'p-2 h6 fw-bold small';
                    span.textContent = breadcrumb.name;
                    li.appendChild(span);
                } else {
                    const a = document.createElement('a');
                    a.href = "#";
                    a.textContent = index === 0 ? '{{ product.product_name }}' : breadcrumb.name;
                    a.className = 'breadcrumb-link text-primary-custom opacity-75 breadcrumb-navigation p-2 h6 small';
                    a.setAttribute('data-folder-id', breadcrumb.id);
                    a.setAttribute('data-product-id', productId);
                    a.setAttribute('data-moving-folder-id', movingFolderId);
                    li.appendChild(a);
                }
                breadcrumbContainer.appendChild(li);
            });
        }
    });
</script>

<!-- View and Edit Comment Modal-->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var commentModal = document.getElementById('commentModal');
        commentModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var documentId = button.getAttribute('data-document-id');
            var modalBody = document.querySelector('#commentModal .modal-body');
            var tableBody = document.querySelector('#commentsTable tbody');

            modalBody.dataset.documentId = documentId;

            fetch(`/documents/document/ajax/comments/${documentId}/`)
                .then(response => response.json())
                .then(data => {
                    tableBody.innerHTML = ''; // Clear previous entries
                    data.versions.forEach(function(version) {
                        var row = document.createElement('tr'); // Create a new table row
                        row.innerHTML = `
                            <td class="text-center align-middle">${version.version}</td>
                            <td id="modified-time-${version.version}" class="text-center align-middle">${version.modified}</td>
                            <td class="text-center align-middle">${version.uploader}</td>
                            <td id="comment-text-${version.version}" class="text-start align-middle">${version.comment}</td>
                            <td id="" class="text-center align-middle">${version.is_editable ? `<button class="btn btn-sm btn-edit-save btn-primary" onclick="editComment(${documentId}, ${version.version})">Edit</button>` : ''}</td>
                        `;
                        tableBody.appendChild(row); // Append the row to the table body
                    });
                })
                .catch(error => console.error('Error loading comments:', error));
        });
    });

    function editComment(documentId, versionNumber) {
        const commentCell = document.getElementById(`comment-text-${versionNumber}`);
        const originalComment = commentCell.textContent; // Get the current comment text
        const buttonCell = commentCell.nextElementSibling; // Assuming the button is next to the comment cell

        commentCell.innerHTML = `<textarea class="form-control form-control-sm">${originalComment}</textarea>`;
        buttonCell.innerHTML = `<button class="btn btn-sm btn-edit-save btn-primary" onclick="saveComment(${documentId}, ${versionNumber})">Save</button>`;
    }

    function saveComment(documentId, versionNumber) {
        const commentCell = document.getElementById(`comment-text-${versionNumber}`);
        const textarea = commentCell.querySelector('textarea');
        const newText = textarea.value;

        fetch(`/documents/document/${documentId}/edit_comment/version/${versionNumber}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `comment=${encodeURIComponent(newText)}`
        })
        .then(response => response.json()) // Ensure server sends back JSON
        .then(data => {
            if (data.success) {

                commentCell.innerHTML = newText; // Update the comment cell with new text
                const buttonCell = commentCell.nextElementSibling; // Get the cell containing the button
                const modifiedTimeCell = document.querySelector(`#modified-time-${versionNumber}`);
                modifiedTimeCell.innerText = data.modified;

                buttonCell.innerHTML = `<button class="btn btn-sm btn-edit-save btn-primary" onclick="editComment(${documentId}, ${versionNumber})">Edit</button>`;
            } else {
                console.error(data.error || 'Failed to update comment. Please try again.');
                alert(data.error || 'Failed to update comment. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error updating comment:', error);
        });
    }
</script>

<!-- Update Document modal -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        $('#updateDocumentModal').on('show.bs.modal', function(event) {
            var button = $(event.relatedTarget);  // Button that triggered the modal
            var documentId = button.data('document-id');  // Use jQuery's data method to access data attributes

            var modal = $(this);
            modal.find('#product_id').val(documentId);  // Set the hidden input value to the document ID
        });

        var updateForm = document.getElementById('updateDocumentForm');
        updateForm.addEventListener('submit', function(event) {
            event.preventDefault();
            var formData = new FormData(updateForm);
            var documentId = updateForm.querySelector('#product_id').value;  // Ensure correct value assignment
            
            fetch(`/documents/document/ajax/update/${documentId}/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken') // Ensure CSRF token is included
                },
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    setSessionMessage(data.error, 'error');
                } else {
                    setSessionMessage(data.message, 'success');
                }
            })
            .catch(error => {
                setSessionMessage('Failed to update due to a network error.', 'error');
            })
            .finally(() => {
                location.reload();
                $('#updateDocumentModal').modal('hide');
            });
        });
        handleSessionMessage();
    });
</script>


<!-- document version modal -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var versionsModal = document.getElementById('documentVersionsModal');

        versionsModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var documentId = button.getAttribute('data-document-id');
            var versionList = document.getElementById('versionList');

            fetch(`/documents/document/ajax/versions/${documentId}/`)
                .then(response => response.json())
                .then(data => {
                    versionList.innerHTML = ''; // Clear previous entries
                    if (data.is_owner) {
                        // Render owner-specific view
                        data.versions.forEach(function(version) {
                            var row = document.createElement('tr');
                            row.innerHTML = `
                                <td class="text-center align-middle">${version.version}</td>
                                <td class="text-start align-middle">${version.filename}</td>
                                <td class="text-center align-middle">${version.modified}</td>
                                <td class="text-center align-middle">${version.uploader}</td>
                                <td class="text-center align-middle"><a href="${version.download_url}" class="badge bg-primary-custom rounded-pill p-2 text-white align-middle">Download</a></td>
                            `;
                            versionList.appendChild(row);
                        });
                    } else {
                        // Render general user view
                        data.versions.forEach(function(version) {
                            var row = document.createElement('tr');
                            row.innerHTML = `
                                <td class="text-center">${version.version}</td>
                                <td class="text-start">${version.filename}</td>
                                <td class="text-center">${version.modified}</td>
                                <td class="text-center">${version.uploader}</td>
                                <td class="text-center align-middle"><a href="${version.download_url}" class="badge bg-primary-custom rounded-pill p-2 text-white align-middle">Download</a></td>
                            `;
                            versionList.appendChild(row);
                        });
                    }
                })
            .catch(error => console.error('Error loading versions:', error));
        });
    });
</script>

<!-- edit document modal -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var editModal = document.getElementById('editDocumentModal');
        editModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget; // Button that triggered the modal
            var documentId = button.getAttribute('data-document-id'); // Extract info from data-* attributes
            var form = document.getElementById('editDocumentForm');
            form.action = `/documents/document/edit/${documentId}/`; // Update the form's action attribute

            // Fetch document details via AJAX
            fetch(`/documents/document/ajax/${documentId}/`)
                .then(response => response.json())
                .then(data => {
                    var documentTypeSelect = document.getElementById('id_document_type');
                    documentTypeSelect.innerHTML = ''; // Clear previous options

                    // Populate document types
                    data.document_types.forEach(function(type) {
                        var option = new Option(type.type_name, type.id); // Corrected from type.name to type.type_name
                        documentTypeSelect.add(option);
                    });

                    // Set the selected value
                    documentTypeSelect.value = data.document_type_id;

                    document.getElementById('id_original_filename').value = data.original_filename;
                    document.getElementById('id_comments').value = data.comments; // Use .value for textarea to ensure text is set correctly
                })
                .catch(error => console.error('Error loading document data:', error));
        });
    });
</script>

<!-- remove access modal -->
<script>
    
    function removeAccess(partnerId, entityType, entityId, productId) {
        document.getElementById('confirmationModal').style.display = 'block';

        document.getElementById('confirmBtn').onclick = function() {
            const url = `/access_control/remove_specific_access/${productId}/${entityType}/${entityId}/`;
            const data = {
                'csrfmiddlewaretoken': '{{ csrf_token }}',
                'partner_id': partnerId
            };
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    sessionStorage.setItem('message', 'Access removed');
                    sessionStorage.setItem('messageType', 'success');
                } else {
                    sessionStorage.setItem('message', 'Failed to remove access. Please try again.');
                    sessionStorage.setItem('messageType', 'error');
                }
            })
            .catch(error => {
                sessionStorage.setItem('message', 'Error connecting to the server. Please try again.');
                sessionStorage.setItem('messageType', 'error');
            })
            .finally(() => {
                location.reload(); // Reload the page to display the message
                document.getElementById('confirmationModal').style.display = 'none';
            });
            handleSessionMessage();
        };

        

        document.querySelectorAll('.close-modal-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.getElementById('confirmationModal').style.display = 'none';
            });
        });
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        const message = sessionStorage.getItem('message');
        const messageType = sessionStorage.getItem('messageType');
    
        if (message && messageType) {
            showMessage(message, messageType); // Use your existing showMessage function
            sessionStorage.removeItem('message'); // Clear the message
            sessionStorage.removeItem('messageType'); // Clear the message type
        }
    });

</script>

<!-- edit folder mdoal -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var editModal = document.getElementById('editFolderModal');
        editModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget; // Button that triggered the modal
            var folderId = button.getAttribute('data-folder-id');
            var productId = button.getAttribute('data-product-id');
            var form = document.getElementById('editFolderForm'); // Ensure this ID is set on the form element

            form.action = `/folder/${productId}/explorer/${folderId}/edit_folder/`; // Set form action

            // Fetch folder details via AJAX
            fetch(`/folder/ajax/${productId}/${folderId}/`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('id_name').value = data.name;
                    document.getElementById('id_parent').value = data.parent_id; // Handle hidden parent input if used
                })
                .catch(error => console.error('Error loading folder data:', error));
        });
    });
</script>


<script>
    $(document).ready(function() {
        $('.dropdown').on('show.bs.dropdown', function(e) {
            var $dropdownMenu = $(this).find('.dropdown-menu');
            var $dropdownToggle = $(this).find('.dropdown-toggle');
            
            // Temporarily detach the menu to move it to the body
            $('body').append($dropdownMenu.detach());
            
            // Get positioning details
            var toggleOffset = $dropdownToggle.offset();
            var toggleHeight = $dropdownToggle.outerHeight();
            var menuWidth = $dropdownMenu.outerWidth();
            var toggleWidth = $dropdownToggle.outerWidth();
            
            // Adjust dropdown's positioning to open to the left
            $dropdownMenu.css({
                'display': 'block',
                'top': toggleOffset.top + toggleHeight + "px", // Position below the toggle button
                'left': toggleOffset.left - menuWidth + "px", // Adjust to open to the left
                'position': 'absolute'
            });
            
            // Prevent scrolling to the bottom
            $dropdownMenu.addClass('position-fixed');
        }).on('hide.bs.dropdown', function(e) {
            var $dropdownMenu = $(this).find('.dropdown-menu');
            
            // Move the menu back to its original parent
            $(this).append($dropdownMenu.detach());
            $dropdownMenu.css({
                'display': '',
                'position': '',
                'top': '',
                'left': ''
            });
            
        });
    });
</script>

<!-- Highlighting Row and Right Panel information showing and resetting -->
<!--
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Initial product name to revert back when no row is selected
        const initialProductName = document.querySelector('#right-panel-title').textContent;
        const productNameElement = document.querySelector('#right-panel-title');

        document.addEventListener('click', function(event) {
            const modal = document.getElementById('confirmationModal');
            const isModalOpen = modal.style.display === 'block';
            
            // Condition to check if the click is outside clickable rows, outside detail panel, and no modal is currently shown
            if (!event.target.closest('.clickable-row') && !event.target.closest('#detail') && !isModalOpen) {
                showLoading();
                document.querySelectorAll('.clickable-row').forEach(row => row.classList.remove('highlighted-row'));
                productNameElement.textContent = initialProductName;
                resetRightPanel();
                resetLeftPanel();
                hideLoading();
            }
        });

        document.querySelectorAll('.clickable-row').forEach(row => {
            row.addEventListener('click', function() {
                const isSelected = this.classList.contains('highlighted-row');
                if (!isSelected) {
                    showLoading();
                    document.querySelectorAll('.clickable-row').forEach(r => r.classList.remove('highlighted-row'));
                    this.classList.add('highlighted-row');
                    updatePanelsBasedOnSelection(this);
                } else {
                    productNameElement.textContent = initialProductName;
                    resetRightPanel();
                    resetLeftPanel();
                    hideLoading();
                }
            });
        });

        function fetchPartnersWithAccess(itemType, itemId) {
            const url = `/access_control/get_partners_with_access_json/${itemId}/${itemType}/`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    updateLeftPanel(data, itemType, itemId);
                    hideLoading(); // Hide loading after async operation is complete
                })
                .catch(error => {
                    console.error('Error loading partners:', error);
                    hideLoading(); // Ensure loading is hidden on error
                });
        }

        function updateLeftPanel(partners, itemType, itemId) {
            const panel = document.getElementById('access-information');
            let html = partners.length > 0 ? '' : '<div class="detail-item"><strong>No Partners Granted Access</strong></div>';
            partners.forEach(partner => {
                html += `<div class="list-group-item list-group-item-action partner-access-item" data-partner-id="${partner.partner2_id}" tabindex="0">
                    <div class="d-flex py-1">
                        <div class="visually-hidden" style="align-self: center;"><input type="radio" name="partners" value="${partner.partner2_id}" id="partner_${partner.partner2_id}"></div>
                        <div class="flex-grow-1 d-flex flex-column ms-3">
                            <div class="fw-bold">${partner.company_name}</div>
                            <div class="text-primary-custom fw-medium small">${partner.company_role}</div>
                            <div class="small">${partner.access_detail}</div>
                        </div>
                        <button type="button" class="btn btn-danger btn-sm remove-access" onclick="removeAccess(this.getAttribute('data-partner-id'), '${itemType}', ${itemId}, ${productId})" data-partner-id="${partner.partner2_id}" style="align-self:center;">Remove</button>
                    </div>
                </div>`;
            });
            panel.innerHTML = html;
        }

        function resetLeftPanel() {
            // Implement according to what needs to be reset or cleared in the right panel
            // For example:
            document.getElementById("access-information").innerHTML = `
                <img src="{% static 'images/empty_state/no_partners.png' %}" alt="Select an item to show information" class="mt-5 text-center" style="align-self:center;" width="210" height="180">
                <small class="text-center mt-3">Select an item to show information</small>
                `;
            document.querySelectorAll('.clickable-row').forEach(r => r.classList.remove('highlighted-row'));
        }

        // Function to update the right panel with selected item details
        function updateRightPanel(data) {
            const { owner, type, version, fileType, name, original, modified, category, createdBy, created, filesize, latestComment } = data;
            if (type === "document") {
                document.getElementById("details-information").innerHTML = `
                    <div class="detail-item"><strong>Original Name</strong><small>${original}</small></div>
                    <div class="detail-item"><strong>Category</strong><small>${category}</small></div>
                    <div class="detail-item"><strong>Latest Comment</strong><small>${latestComment}</small></div>
                    <div class="detail-item"><strong>Owner</strong><small>${owner}</small></div>
                    <div class="detail-item"><strong>File Size</strong><small>${filesize}</small></div>
                    <div class="detail-item"><strong>Version</strong><small>${version}</small></div>
                    <div class="detail-item"><strong>Modified</strong><small>${modified} by ${createdBy}</small></div>
                    <div class="detail-item"><strong>Created</strong><small>${created}</small></div>
                    `;
                    // Switch to the details tab
                    // new bootstrap.Tab(document.querySelector('#details-tab')).show();
            }
            else if (type === "folder") {
                document.getElementById("details-information").innerHTML = `
                    <div class="detail-item"><strong>Owner</strong><small>${owner}</small></div>
                    <div class="detail-item"><strong>Modified</strong><small>${modified}</small></div>
                    <div class="detail-item"><strong>Created</strong><small>${created}</small></div>
                    `;
                    // Switch to the details tab
                    // new bootstrap.Tab(document.querySelector('#details-tab')).show();
            }
        }
        

        function resetRightPanel() {
            // Implement according to what needs to be reset or cleared in the right panel
            // For example:
            document.getElementById("details-information").innerHTML = `
                <img src="{% static 'images/empty_state/show_info2.png' %}" alt="Select an item to show information" class="mt-5 text-center" style="align-self:center;" width="210" height="180">
                <small class="text-center mt-3">Select an item to show information</small>
                `;
            document.querySelectorAll('.clickable-row').forEach(r => r.classList.remove('highlighted-row'));
        }

        function getIconHTML(fileType) {
            // Define your icons here
            const icons = {
                '.PDF': '<svg class="" width="20" height="23" viewBox="0 0 15 18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6.8 0V5.525C6.8 6.18774 7.30568 6.73238 7.95221 6.79416L8.075 6.8H13.6V15.3C13.6 16.1962 12.9065 16.9304 12.0269 16.9953L11.9 17H1.7C0.803792 17 0.0695594 16.3065 0.0046627 15.4269L0 15.3L0 1.7C0 0.803792 0.693496 0.0695596 1.57313 0.00466291L1.7 0L6.8 0ZM8.5 0.036856C8.77387 0.094843 9.03044 0.219882 9.24584 0.402096L9.35 0.497921L13.1021 4.25C13.3031 4.451 13.4486 4.69715 13.5286 4.96461L13.5631 5.1H8.5V0.036856Z" fill="#295893"/></svg>',
                '.WORD': '<img src="{% static "icons/word-icon.png" %}" alt="Word" width="16" height="16" class="">',
                '.PNG': '<svg class="" width="23" height="19" viewBox="0 0 17 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14.4 0C15.2837 0 16 0.696446 16 1.55556V12.4444C16 13.3036 15.2837 14 14.4 14H1.6C0.716344 14 0 13.3036 0 12.4444L0 1.55556C0 0.696446 0.716344 0 1.6 0L14.4 0ZM14.4 1.55556L1.6 1.55556L1.6 9.4115L5.59584 5.52666C5.98637 5.147 6.61952 5.147 7.01008 5.52666L10.2627 8.68902L11.2527 7.7266C11.6432 7.34689 12.2764 7.34689 12.6669 7.7266L14.4 9.4115V1.55556ZM10.8 3.11111C11.4627 3.11111 12 3.63344 12 4.27778C12 4.92211 11.4627 5.44444 10.8 5.44444C10.1373 5.44444 9.6 4.92211 9.6 4.27778C9.6 3.63344 10.1373 3.11111 10.8 3.11111Z" fill="#AC3140"/></svg>',
                '.JPG': '<svg class="" width="23" height="19" viewBox="0 0 17 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14.4 0C15.2837 0 16 0.696446 16 1.55556V12.4444C16 13.3036 15.2837 14 14.4 14H1.6C0.716344 14 0 13.3036 0 12.4444L0 1.55556C0 0.696446 0.716344 0 1.6 0L14.4 0ZM14.4 1.55556L1.6 1.55556L1.6 9.4115L5.59584 5.52666C5.98637 5.147 6.61952 5.147 7.01008 5.52666L10.2627 8.68902L11.2527 7.7266C11.6432 7.34689 12.2764 7.34689 12.6669 7.7266L14.4 9.4115V1.55556ZM10.8 3.11111C11.4627 3.11111 12 3.63344 12 4.27778C12 4.92211 11.4627 5.44444 10.8 5.44444C10.1373 5.44444 9.6 4.92211 9.6 4.27778C9.6 3.63344 10.1373 3.11111 10.8 3.11111Z" fill="#AC3140"/></svg>',
                '.SVG': '<svg class="" width="23" height="19" viewBox="0 0 17 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14.4 0C15.2837 0 16 0.696446 16 1.55556V12.4444C16 13.3036 15.2837 14 14.4 14H1.6C0.716344 14 0 13.3036 0 12.4444L0 1.55556C0 0.696446 0.716344 0 1.6 0L14.4 0ZM14.4 1.55556L1.6 1.55556L1.6 9.4115L5.59584 5.52666C5.98637 5.147 6.61952 5.147 7.01008 5.52666L10.2627 8.68902L11.2527 7.7266C11.6432 7.34689 12.2764 7.34689 12.6669 7.7266L14.4 9.4115V1.55556ZM10.8 3.11111C11.4627 3.11111 12 3.63344 12 4.27778C12 4.92211 11.4627 5.44444 10.8 5.44444C10.1373 5.44444 9.6 4.92211 9.6 4.27778C9.6 3.63344 10.1373 3.11111 10.8 3.11111Z" fill="#AC3140"/></svg>',
                // Add more as needed
                'DEFAULT': '<svg class="icon-folder" xmlns="http://www.w3.org/2000/svg" width="22" height="20" fill="currentColor" viewBox="0 0 18 16"><path d="M16 6.32099V12.642C16 13.4751 15.3473 14.1576 14.5194 14.2179L14.4 14.2222H1.6C0.75651 14.2222 0.0654679 13.5776 0.00438862 12.7599L0 12.642L0 6.32099L16 6.32099ZM6.0155 0C6.45292 0 6.86907 0.176755 7.16925 0.485378L7.26488 0.593075L8.38448 1.97531L14.4 1.97531C15.2435 1.97531 15.9345 2.61995 15.9956 3.43762L16 3.55556V4.74074L0 4.74074L0 1.58025C0 0.747171 0.652702 0.0646597 1.48059 0.00433444L1.6 0L6.0155 0Z" fill="#CCA92D"/></svg>' // Default icon
            };
            if (!fileType) {
                return icons['DEFAULT']; // Return default icon or an empty string if no icon should be shown
            }

            return icons[fileType.toUpperCase()] || icons['DEFAULT']; // Return matching icon or default
        }

        function updatePanelsBasedOnSelection(selectedRow) {
            const fileType = selectedRow.dataset.filetype;
            const iconHTML = getIconHTML(fileType);
            const name = selectedRow.dataset.name;
            const itemId = selectedRow.dataset.id;
            const itemType = selectedRow.dataset.type;

            productNameElement.innerHTML = `${iconHTML} <span class="name-container py-3">${name}</span>`;
            updateRightPanel(selectedRow.dataset);
            fetchPartnersWithAccess(itemType, itemId);
        }

    });
</script>
-->
{% endblock %}

{% endblock %}